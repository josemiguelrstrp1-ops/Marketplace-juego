<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marketplace Juego - Online</title>
<style>
  :root{--bg:#f5f7fa;--card:#fff;--accent:#0b8;--muted:#666}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#111}
  header{background:#0b8;color:#fff;padding:12px;text-align:center;font-weight:700}
  .app{max-width:1000px;margin:14px auto;padding:12px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);margin-bottom:12px}
  input,select,button{font-size:15px;padding:8px;border-radius:8px;border:1px solid #ddd}
  button{background:#0b8;color:#fff;border:0}
  .row{display:flex;gap:8px;align-items:center}
  #juegoArea{height:260px;background:#0e0e0e;border-radius:8px;position:relative;overflow:hidden;margin-top:8px}
  #player{position:absolute;left:45%;bottom:8%;width:9%;min-width:36px;height:12%;min-height:36px;background:#4caf50;border-radius:8px}
  .cubo{position:absolute;border-radius:6px}
  .small{font-size:13px;color:var(--muted)}
  .obj{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid #eee;margin-bottom:6px;background:#fff}
  .side{max-width:360px;margin-left:12px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .badge{padding:4px 7px;border-radius:999px;font-weight:700;font-size:12px}
  footer{text-align:center;padding:8px;color:var(--muted)}
  .backBtn{background:#666;color:#fff}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>Marketplace Juego - En lÃ­nea</header>
<div class="app">

  <!-- LOGIN -->
  <div class="card" id="screen-login">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="userInput" placeholder="Usuario"/>
      <input id="passInput" placeholder="ContraseÃ±a" type="password"/>
      <button id="btnCreate">Crear cuenta (3 comunes)</button>
      <button id="btnLogin">Entrar</button>
    </div>
    <div class="small" style="margin-top:8px">Al crear cuenta recibirÃ¡s 3 objetos <strong>ComÃºn</strong> y 50 CarriCoins.</div>
  </div>

  <div class="grid">

    <div>

      <!-- MENU -->
      <div class="card" id="screen-menu" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div><strong>Usuario:</strong> <span id="meUser">â€”</span></div>
            <div class="small">Coins: <span id="meCoins">0</span> Â· Tickets: <span id="meTickets">0</span></div>
          </div>
          <div style="text-align:right">
            <div class="small">Chat se borra cada 3 min</div>
            <button id="btnLogout" style="background:#e44">Salir</button>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;gap:8px">
          <button id="openGame">Jugar: Esquivar cubos</button>
          <button id="openMarket">Marketplace</button>
          <button id="openInv">Inventario</button>
          <button id="openHist">Historial</button>
          <button id="openRuleta">Ruleta & Tickets</button>
          <button id="openChat">Chat Global</button>
        </div>
      </div>

      <!-- MINIJUEGO -->
      <div class="card" id="screen-game" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Minijuego - Esquivar cubos</strong><div class="small">Al reiniciar se transfieren puntos a Coins si estÃ¡s logueado</div></div>
          <div>Puntos: <strong id="gameScore">0</strong></div>
        </div>

        <div id="juegoArea">
          <div id="player"></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="left">â¬…ï¸</button>
          <button id="right">â¡ï¸</button>
          <button id="restartGame" style="background:#167">ğŸ”„ Reiniciar (pasar puntos a Coins)</button>
          <button id="pauseGame" style="background:#666">â¹ï¸ Pausar</button>
        </div>

        <div style="margin-top:8px">
          <button class="backBtn" onclick="show('menu')">Volver al menÃº</button>
        </div>
      </div>

      <!-- MARKETPLACE -->
      <div class="card" id="screen-market" style="display:none">
        <h3>Marketplace</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
          <select id="sellSelect"></select>
          <input id="sellPrice" placeholder="Precio CC" style="width:120px"/>
          <button id="btnPutSale">Poner en venta</button>
          <button class="backBtn" onclick="show('menu')">Volver al menÃº</button>
        </div>
        <h4>Productos a la venta</h4>
        <div id="marketList" style="max-height:260px;overflow:auto"></div>
      </div>

      <!-- INVENTARIO -->
      <div class="card" id="screen-inv" style="display:none">
        <h3>Inventario</h3>
        <div id="invList" style="max-height:320px;overflow:auto"></div>
        <div style="margin-top:8px"><button class="backBtn" onclick="show('menu')">Volver al menÃº</button></div>
      </div>

      <!-- HISTORIAL -->
      <div class="card" id="screen-hist" style="display:none">
        <h3>Historial de ventas</h3>
        <div id="histList" style="max-height:320px;overflow:auto"></div>
        <div style="margin-top:8px"><button class="backBtn" onclick="show('menu')">Volver al menÃº</button></div>
      </div>

      <!-- RULETA / GIFT -->
      <div class="card" id="screen-ruleta" style="display:none">
        <h3>Ruleta & Tickets</h3>
        <div class="small">Tickets: <span id="uiTickets">0</span></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button id="buy1">Comprar 1 (100 CC)</button>
          <button id="buy10">Comprar 10 (900 CC)</button>
          <button id="useTicket">Usar Ticket</button>
        </div>

        <hr/>

        <h4>Regalo</h4>
        <div class="small">Toca 500 veces para ganar un objeto aleatorio</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="giftBtn">ğŸ</button>
          <div class="small" id="giftCnt">0 / 500</div>
        </div>

        <div style="margin-top:8px"><button class="backBtn" onclick="show('menu')">Volver al menÃº</button></div>
      </div>

    </div>

    <!-- SIDEBAR: CHAT, JUGADORES, OBJETOS POR RANGO -->
    <div class="side">

      <div class="card" id="screen-chat" style="display:none">
        <h4>Chat Global</h4>
        <div id="chatBox" style="height:220px;overflow:auto;border:1px solid #eee;padding:8px;background:#fff"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="chatInput" placeholder="Escribe..." />
          <button id="sendChat">Enviar</button>
        </div>
        <div style="margin-top:8px">
          <button class="backBtn" onclick="show('menu')">Volver al menÃº</button>
        </div>
      </div>

      <div class="card">
        <h4>Jugadores Activos</h4>
        <div id="playersBox" style="max-height:150px;overflow:auto"></div>
        <h4 style="margin-top:8px">Top Coins</h4>
        <div id="topBox" style="max-height:120px;overflow:auto"></div>
      </div>

      <div class="card">
        <h4>Objetos por rareza</h4>
        <div id="objectsBox" style="max-height:340px;overflow:auto"></div>
      </div>

    </div>

  </div>

</div>

<footer>Listo para desplegar en GitHub Pages + Firebase Realtime</footer>

<!-- FIREBASE (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

<script>
/* ------------------ TU FIREBASE CONFIG --------------------
   (ya me diste este config antes â€” estÃ¡ usado aquÃ­)
------------------------------------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyADVjuoLhcH34XPmZv-sx-eP71rIxVEKEY",
  authDomain: "juego-marketplace.firebaseapp.com",
  databaseURL: "https://juego-marketplace-default-rtdb.firebaseio.com/",
  projectId: "juego-marketplace",
  storageBucket: "juego-marketplace.firebasestorage.app",
  messagingSenderId: "258620166110",
  appId: "1:258620166110:web:3a101d6f7743b6dbc6574f",
  measurementId: "G-0GZDE8FNEC"
};

firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();
const refUsers = rdb.ref('usuarios');
const refChat = rdb.ref('chat');
const refVentas = rdb.ref('ventas');

/* ------------------ OBJETOS (lista que pediste) ------------------ */
/* RANGOS y sus items (usÃ© exactamente los emojis/nombres que mandaste, agrupados) */
const objetosPorRango = {
  "ComÃºn": ["ğŸ»","ğŸº","ğŸ¶","ğŸ±","ğŸ¯"],
  "Poco comÃºn": ["ğŸ¨","ğŸ¦","ğŸµ","ğŸ™‰","ğŸ®"],
  "Ã‰pico": ["ğŸ¦","ğŸ¦Š","ğŸ°","ğŸ­","ğŸ¹","ğŸ»â€â„ï¸"],
  "MÃ­tico": ["ğŸ—½","ğŸ—¿","ğŸŒ¬ï¸","ğŸŒ€","ğŸŒªï¸"],
  "Legendarios": ["ğŸ¦ ","ğŸª±","ğŸ›","ğŸŒŠ","ğŸŒ„"],
  "UltraLegendarios": ["ğŸ¤–","ğŸƒ","ğŸ‘¿","â›„","ğŸ‘º","â˜ ï¸"],
  "Xprn": ["ğŸ„","ğŸŒµ","ğŸŒ´","ğŸŒ³","ğŸŒ²"],            /* xprn group */
  "Toxtor": ["ğŸ¦•","ğŸ¦–","ğŸŠ","ğŸ","ğŸ¦"],        /* toxtor */
  "Gamma": ["ğŸ¦„","ğŸ—","ğŸ¦«","ğŸ¦¨","ğŸ¦‡","ğŸ¦œ"],
  "Dioses": ["ğŸ²","ğŸ¦","ğŸ¦š"],
  "Maestro": ["ğŸ•","ğŸ”¯","âœ¡ï¸","â˜¦ï¸","âœï¸","ğŸª¯","â˜ªï¸","â˜¯ï¸","â˜®ï¸","â˜¸ï¸","ğŸ•‰ï¸","ğŸ›","âš›ï¸"]
};

/* ------------------ MUTACIONES ------------------ */
const mutaciones = [
  {code:"", prob:85},
  {code:"CH", prob:6},
  {code:"GH", prob:4},
  {code:"TH", prob:3},
  {code:"RH", prob:1.5},
  {code:"HH", prob:0.5}
];

/* ------------------ PROBABILIDADES por RANGO (% sumando ~100) ------------------
   entre mÃ¡s alto el rango, menos probabilidad (ajustable)
--------------------------------------------------------------------*/
const probRangos = [
  {rango:"ComÃºn", prob:30},
  {rango:"Poco comÃºn", prob:20},
  {rango:"Ã‰pico", prob:15},
  {rango:"MÃ­tico", prob:8},
  {rango:"Legendarios", prob:7},
  {rango:"UltraLegendarios", prob:5},
  {rango:"Xprn", prob:4},
  {rango:"Toxtor", prob:3},
  {rango:"Gamma", prob:3},
  {rango:"Dioses", prob:2},
  {rango:"Maestro", prob:1}
];

/* ------------------ FUNCIONES AUX ------------------ */
function elegirPorProb(list){
  const r = Math.random()*100; let s=0;
  for(let i=0;i<list.length;i++){ s+=list[i].prob; if(r<=s) return list[i]; }
  return list[0];
}

function obtenerObjetoAleatorio(){
  const sel = elegirPorProb(probRangos).rango;
  const pool = objetosPorRango[sel] || objetosPorRango["ComÃºn"];
  const base = pool[Math.floor(Math.random()*pool.length)];
  const mut = elegirPorProb(mutaciones).code;
  const name = mut ? `${base} (${mut})` : base;
  return { nombre: name, rango: sel };
}

/* ------------------ ESTADO CLIENTE ------------------ */
let me = null; // {user, coins, tickets, objetos:[], historial:[]}
let chatCache = [];
let ventasCache = {};

/* ------------------ UI helpers ------------------ */
const $ = id => document.getElementById(id);

function show(screen){
  // hide all screens
  ['screen-login','screen-menu','screen-game','screen-market','screen-inv','screen-hist','screen-ruleta','screen-chat'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = 'none';
  });
  document.getElementById('screen-'+screen).style.display = 'block';
}

/* render objects by range */
function renderObjectsBox(){
  const cont = $('objectsBox'); cont.innerHTML = '';
  Object.keys(objetosPorRango).forEach(r=>{
    objetosPorRango[r].slice(0,6).forEach(n=>{
      const d = document.createElement('div'); d.className='obj'; d.innerHTML = `<div><strong>${n}</strong><div class="small">${r}</div></div><div><span class="badge">${r}</span></div>`;
      cont.appendChild(d);
    });
  });
}

/* show me */
function refreshMeUI(){
  $('meUser').innerText = me ? me.user : 'â€”';
  $('meCoins').innerText = me ? (me.coins||0) : 0;
  $('meTickets').innerText = me ? (me.tickets||0) : 0;
  $('uiTickets').innerText = me ? (me.tickets||0) : 0;
}

/* render inventario */
function renderInv(){
  const inv = $('invList'); inv.innerHTML = '';
  if(!me || !me.objetos || me.objetos.length===0){ inv.innerHTML = '<div class="small">Inventario vacÃ­o</div>'; return; }
  me.objetos.forEach((o,i)=>{
    const d = document.createElement('div'); d.className='obj';
    d.innerHTML = `<div><strong>${o.nombre}</strong><div class="small">${o.rango}</div></div><div><button onclick="sellIndex(${i})">Vender</button></div>`;
    inv.appendChild(d);
  });
  // rellena select sell
  const sel = $('sellSelect'); if(sel){ sel.innerHTML=''; me.objetos.forEach((o,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.text=`${o.nombre} (${o.rango})`; sel.appendChild(opt); }); }
}

/* render ventas */
function renderVentas(){
  const list = $('marketList'); list.innerHTML='';
  Object.keys(ventasCache).forEach(k=>{
    const v = ventasCache[k];
    const d = document.createElement('div'); d.className='obj';
    d.innerHTML = `<div><strong>${v.nombre}</strong><div class="small">${v.rango}</div><div class="small">Vende: ${v.vendedor}</div></div>`;
    const right = document.createElement('div'); right.innerHTML = `<div class="small">${v.precio} CC</div>`;
    const btn = document.createElement('button');
    btn.textContent = (me && me.user === v.vendedor) ? 'Tu venta' : 'Comprar';
    btn.disabled = (me && me.user === v.vendedor);
    btn.onclick = ()=> comprarVenta(k);
    right.appendChild(btn);
    d.appendChild(right);
    list.appendChild(d);
  });
}

/* render chat */
function renderChat(){
  const box = $('chatBox'); box.innerHTML = '';
  chatCache.forEach(m=>{
    const d = document.createElement('div'); d.innerHTML = `<small class="small">${new Date(m.ts).toLocaleTimeString()}</small> <strong>${m.usuario}</strong>: ${m.texto}`;
    box.appendChild(d);
  });
  box.scrollTop = box.scrollHeight;
}

/* render players top */
function renderPlayersAndTop(usersObj){
  const players = $('playersBox'); players.innerHTML=''; const top = $('topBox'); top.innerHTML='';
  const arr = Object.keys(usersObj||{}).map(u=>({user:u, coins: usersObj[u].coins||0, last: usersObj[u].lastSeen||0}));
  arr.sort((a,b)=>b.last - a.last);
  arr.forEach(p=>{ const d=document.createElement('div'); d.className='small'; d.innerText = `${p.user} â€¢ ${p.coins} CC`; players.appendChild(d); });
  arr.sort((a,b)=>b.coins - a.coins).slice(0,10).forEach(t=>{ const d=document.createElement('div'); d.className='small'; d.innerText = `${t.user}: ${t.coins} CC`; top.appendChild(d); });
}

/* ------------------ AUTH & USER FLOW ------------------ */
/* crear cuenta: recibe 3 comunes y 50 coins */
$('btnCreate').addEventListener('click', ()=>{
  const user = $('userInput').value.trim(); const pass = $('passInput').value.trim();
  if(!user || !pass) return alert('Usuario y contraseÃ±a requeridos');
  refUsers.child(user).get().then(s=>{
    if(s.exists()) return alert('Usuario ya existe');
    // 3 comunes
    const comunes = objetosPorRango['ComÃºn'];
    const objs = []; for(let i=0;i<3;i++){ objs.push({nombre: comunes[Math.floor(Math.random()*comunes.length)], rango:'ComÃºn'}) }
    const payload = { pass: pass, coins:50, tickets:0, objetos: objs, historial: [], lastSeen: Date.now() };
    refUsers.child(user).set(payload).then(()=>{ alert('Cuenta creada con 3 Comunes y 50 CC'); });
  });
});

/* login */
$('btnLogin').addEventListener('click', ()=>{
  const user = $('userInput').value.trim(); const pass = $('passInput').value.trim();
  if(!user || !pass) return alert('Usuario y contraseÃ±a requeridos');
  refUsers.child(user).get().then(s=>{
    if(!s.exists()) return alert('Usuario no existe');
    const data = s.val();
    if(data.pass !== pass) return alert('ContraseÃ±a incorrecta');
    me = { user: user, coins: data.coins||0, tickets: data.tickets||0, objetos: data.objetos||[], historial: data.historial||[] };
    refUsers.child(user).update({ lastSeen: Date.now() });
    // UI
    refreshMeUI(); renderInv(); show('menu');
    // update UI from DB realtime
    refUsers.child(user).on('value', snap => {
      const d = snap.val()||{};
      me.coins = d.coins||0; me.tickets = d.tickets||0; me.objetos = d.objetos||[]; me.historial = d.historial||[];
      refreshMeUI(); renderInv();
    });
  });
});

/* logout */
$('btnLogout').addEventListener('click', ()=>{
  if(me) refUsers.child(me.user).update({ lastSeen: Date.now() });
  me = null; show('login'); $('userInput').value=''; $('passInput').value='';
});

/* ------------------ MARKETPLACE: poner en venta y comprar ------------------ */
function sellIndex(index){
  if(!me) return alert('Inicia sesiÃ³n para vender');
  const price = prompt('Precio en CC para vender este objeto:');
  const p = parseInt(price);
  if(isNaN(p) || p<=0) return alert('Precio invÃ¡lido');
  // quitar del inventario en DB y crear venta
  refUsers.child(me.user).child('objetos').get().then(snap=>{
    const arr = snap.exists() ? snap.val() : [];
    if(!arr[index]) return alert('Objeto no encontrado');
    const obj = arr.splice(index,1)[0];
    refUsers.child(me.user).update({ objetos: arr }).then(()=>{
      const venta = { vendedor: me.user, nombre: obj.nombre, rango: obj.rango, precio: p, ts: Date.now() };
      const key = refVentas.push(venta).key;
      // venta publicada automÃ¡ticamente por listener
      alert('Objeto puesto a la venta');
    });
  });
}

$('btnPutSale').addEventListener('click', ()=>{
  const idx = parseInt($('sellSelect').value);
  const price = parseInt($('sellPrice').value);
  if(isNaN(idx) || isNaN(price) || price<=0) return alert('Selecciona objeto y precio vÃ¡lido');
  sellIndex(idx);
});

/* comprar venta */
function comprarVenta(key){
  if(!me) return alert('Inicia sesiÃ³n para comprar');
  refVentas.child(key).get().then(snap=>{
    if(!snap.exists()) return alert('Venta ya no existe');
    const v = snap.val();
    if(v.vendedor === me.user) return alert('No puedes comprar tu propia venta');
    if((me.coins||0) < v.precio) return alert('No tienes CarriCoins');
    // 1) restar coins comprador
    const newBuyerCoins = (me.coins||0) - v.precio;
    refUsers.child(me.user).update({ coins: newBuyerCoins }).then(()=>{
      // 2) aÃ±adir objeto comprador
      refUsers.child(me.user).child('objetos').get().then(bsnap=>{
        const arr = bsnap.exists() ? bsnap.val() : [];
        arr.push({ nombre: v.nombre, rango: v.rango });
        refUsers.child(me.user).update({ objetos: arr });
        // 3) pagar vendedor y agregar historial
        refUsers.child(v.vendedor).get().then(vsnap=>{
          const seller = vsnap.val() || {};
          const sellerCoins = (seller.coins||0) + v.precio;
          const sellerHist = seller.historial || [];
          sellerHist.push({ vendido: v.nombre, precio: v.precio, cuando: Date.now() });
          refUsers.child(v.vendedor).update({ coins: sellerCoins, historial: sellerHist }).then(()=>{
            // 4) remover venta
            refVentas.child(key).remove();
            alert('Compra exitosa');
          });
        });
      });
    });
  });
}

/* ------------------ TICKETS y RULETAS ------------------ */
$('buy1').addEventListener('click', ()=> comprarTickets(1));
$('buy10').addEventListener('click', ()=> comprarTickets(10));
$('useTicket').addEventListener('click', ()=> usarTicket());

function comprarTickets(cant){
  if(!me) return alert('Inicia sesiÃ³n');
  const precio = cant === 1 ? 100 : 900;
  if((me.coins||0) < precio) return alert('No tienes CC');
  const newCoins = (me.coins||0) - precio;
  const newTickets = (me.tickets||0) + cant;
  refUsers.child(me.user).update({ coins: newCoins, tickets: newTickets });
}

function usarTicket(){
  if(!me) return alert('No tienes tickets');
  refUsers.child(me.user).get().then(snap=>{
    const d = snap.val() || {};
    const tickets = (d.tickets||0) - 1;
    if(tickets < 0) return alert('No tienes tickets');
    refUsers.child(me.user).update({ tickets: tickets }).then(()=>{
      // premio con prob por rango
      const obj = obtenerObjetoAleatorio();
      refUsers.child(me.user).child('objetos').get().then(os=>{
        const arr = os.exists() ? os.val() : [];
        arr.push(obj);
        refUsers.child(me.user).update({ objetos: arr }).then(()=> alert('Ganaste en la ruleta: '+obj.nombre));
      });
    });
  });
}

/* ------------------ REGALO 500 TOQUES ------------------ */
let giftCount = 0;
$('giftBtn').addEventListener('click', ()=>{
  giftCount++; $('giftCnt').innerText = `${giftCount} / 500`;
  if(giftCount >= 500){
    if(!me) return alert('Inicia sesiÃ³n para recibir regalo');
    const obj = obtenerObjetoAleatorio();
    refUsers.child(me.user).child('objetos').get().then(os=>{
      const arr = os.exists() ? os.val() : [];
      arr.push(obj);
      refUsers.child(me.user).update({ objetos: arr }).then(()=> alert('Recibiste: '+obj.nombre));
    });
    giftCount = 0; $('giftCnt').innerText = '0 / 500';
  }
});

/* ------------------ CHAT Realtime (se limpia cada 3 minutos) ------------------ */
$('sendChat').addEventListener('click', ()=> {
  const txt = $('chatInput').value.trim();
  if(!txt) return;
  if(!me) return alert('Inicia sesiÃ³n para chatear');
  refChat.push({ usuario: me.user, texto: txt, ts: Date.now() });
  $('chatInput').value='';
});

/* reset chat cada 3 minutos en servidor: AquÃ­ cliente borra cada 3 min (si quieres hacerlo en servidor, configura un cloud function) */
setInterval(()=>{ refChat.remove(); }, 180000);

/* ------------------ MINIJUEGO (simples cubos) ------------------ */
let score = 0, cubes = [], gameInterval = null, paused = false;
function startGame(){
  if(gameInterval) clearInterval(gameInterval);
  gameInterval = setInterval(()=>{
    if(Math.random() < 0.06){
      spawnCube();
    }
    moveCubes();
  }, 40);
}
function spawnCube(){
  const c = document.createElement('div'); c.className='cubo'; c.style.width='10%'; c.style.height='12%';
  c.style.left = (Math.random()*80)+'%'; c.style.top = '-12%'; c.style.background = '#' + Math.floor(Math.random()*16777215).toString(16);
  $('juegoArea').appendChild(c);
  cubes.push(c);
  setTimeout(()=>{ if(c.parentNode) c.parentNode.removeChild(c); cubes = cubes.filter(x=>x!==c); }, 4000);
}
function moveCubes(){
  cubes.forEach((c)=>{
    const top = parseFloat(c.style.top) || -12;
    c.style.top = (top + 0.7) + '%';
    // colisiÃ³n simple
    const pL = parseFloat($('player').style.left) || 45, pR = pL + 9;
    const cL = parseFloat(c.style.left) || 0, cR = cL + 10;
    const pT = 78, pB = 95;
    const cT = parseFloat(c.style.top), cB = cT + 12;
    if(!(pR < cL || pL > cR || pB < cT || pT > cB)){
      // colisiÃ³n -> transferir score a coins si hay usuario
      if(me) refUsers.child(me.user).get().then(snap=>{
        const d = snap.val() || {};
        const newCoins = (d.coins||0) + score;
        refUsers.child(me.user).update({ coins: newCoins });
      });
      alert('Te chocaste! Ganaste '+score+' CC (transferidos)');
      score = 0; $('gameScore').innerText = score;
      cubes.forEach(cc=>cc.remove()); cubes=[]; clearInterval(gameInterval); gameInterval=null;
    }
  });
}
$('left').addEventListener('click', ()=>{ const cur = parseFloat($('player').style.left)||45; $('player').style.left = Math.max(0,cur-9)+'%'; });
$('right').addEventListener('click', ()=>{ const cur = parseFloat($('player').style.left)||45; $('player').style.left = Math.min(80,cur+9)+'%'; });
$('restartGame').addEventListener('click', ()=>{
  if(me) refUsers.child(me.user).get().then(snap=>{ const d = snap.val()||{}; const newCoins = (d.coins||0) + score; refUsers.child(me.user).update({ coins: newCoins }); });
  score = 0; $('gameScore').innerText = 0;
  cubes.forEach(c=>c.remove()); cubes=[]; if(gameInterval) clearInterval(gameInterval); startGame();
});
$('pauseGame').addEventListener('click', ()=>{
  if(!paused){ paused=true; $('pauseGame').innerText='â–¶ï¸ Reanudar'; if(gameInterval) clearInterval(gameInterval); } else { paused=false; $('pauseGame').innerText='â¹ï¸ Pausar'; startGame(); }
});
/* dar puntos aleatorios mientras el juego corre (simulaciÃ³n de pasar cubos) */
setInterval(()=>{ if(gameInterval && Math.random()<0.12){ score++; $('gameScore').innerText = score; } }, 700);

/* ------------------ LISTENERS y SYNC FIREBASE ------------------ */
refChat.on('value', snap=>{
  const v = snap.val() || {};
  chatCache = Object.keys(v).map(k => v[k]).sort((a,b)=>a.ts - b.ts);
  renderChat();
});

refVentas.on('value', snap=>{
  ventasCache = snap.val() || {};
  renderVentas();
});

refUsers.on('value', snap=>{
  const users = snap.val() || {};
  renderPlayersAndTop(users);
  // si hay sesiÃ³n guardada, sincroniza me
  const saved = localStorage.getItem('mj_user');
  if(saved && (!me || me.user !== saved)){
    refUsers.child(saved).get().then(ss=>{
      const d = ss.val() || {};
      me = { user: saved, coins: d.coins||0, tickets: d.tickets||0, objetos: d.objetos||[], historial: d.historial||[] };
      localStorage.setItem('mj_user', saved);
      refreshMeUI(); renderInv();
    });
  }
});

/* ------------------ PUBLIC FUNCTIONS expuesto globalmente ------------------ */
window.comprarVenta = comprarVenta;
window.sellIndex = sellIndex;

/* ------------------ BOTONES DE NAVEGACIÃ“N desde MENU ------------------ */
$('openGame').addEventListener('click', ()=>{ show('game'); startGame(); });
$('openMarket').addEventListener('click', ()=>{ show('market'); });
$('openInv').addEventListener('click', ()=>{ show('inv'); });
$('openHist').addEventListener('click', ()=>{ show('hist'); });
$('openRuleta').addEventListener('click', ()=>{ show('ruleta'); });
$('openChat').addEventListener('click', ()=>{ show('chat'); });
$('btnLogout').addEventListener('click', ()=>{ if(me) refUsers.child(me.user).update({ lastSeen: Date.now() }); me=null; localStorage.removeItem('mj_user'); show('login'); });

/* ------------------ REWARD al crear cuenta o login --------
   - Ya implementado: crear cuenta da 3 comunes.
   - Si quieres recompensa diaria al iniciar sesiÃ³n, se puede agregar.
------------------------------------------------------------*/

/* ------------------ RENDER inicial ------------------ */
renderObjectsBox();
show('login');
</script>
</body>
</html>
