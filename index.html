<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Marketplace Game</title>
<style>
  body { font-family: Arial; background:#111; color:white; text-align:center; }
  .seccion { display:none; padding:20px; }
  button{ padding:10px; margin:5px; font-size:16px; }
  #chatBox{ width:90%; height:150px; background:#222; margin:auto; padding:10px; overflow-y:scroll; }
  #jugadoresActivos div, #topGlobal div { background:#222; margin:3px; padding:5px; }
</style>
</head>

<body>

<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
<!--       MENÃš DE INICIO     -->
<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
<div id="menuInicio" class="seccion" style="display:block;">
  <h1>Iniciar sesiÃ³n / Crear cuenta</h1>

  <input id="userInput" placeholder="Usuario"><br><br>
  <input id="passInput" type="password" placeholder="ContraseÃ±a"><br><br>

  <button onclick="crearCuenta()">Crear cuenta</button>
  <button onclick="iniciarSesion()">Entrar</button>

</div>

<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
<!--     MENÃš PRINCIPAL     -->
<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
<div id="menuPrincipal" class="seccion">
  <h1>MenÃº Principal</h1>
  <h3 id="saludo"></h3>
  <h3>CarriCoins: <span id="coinsCount">0</span></h3>
  <h3>Tickets: <span id="ticketsCount">0</span></h3>

  <button onclick="mostrar('marketplace')">Marketplace</button><br>
  <button onclick="mostrar('regalo')">Regalo Diario</button><br>
  <button onclick="mostrar('tickets')">Comprar Tickets</button><br>
  <button onclick="mostrar('objLista')">Lista de Objetos</button><br>
  <button onclick="mostrar('juego')">Juego Mini</button><br>
  <button onclick="cerrarSesion()">Cerrar SesiÃ³n</button><br><br>

  <!-- ABAJO: lo que tÃº pediste -->
  <h2>Chat Global</h2>
  <div id="chatBox"></div>
  <input id="chatMensaje" placeholder="Escribe..." style="width:70%;">
  <button onclick="enviarMensaje()">Enviar</button>

  <h2>Jugadores Activos</h2>
  <div id="jugadoresActivos"></div>

  <h2>Top CarriCoins</h2>
  <div id="topGlobal"></div>

  <h2>Objetos por rareza</h2>
  <div id="rarezaBox"></div>

</div>

<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
<!--  OTRAS SECCIONES   -->
<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->

<div id="marketplace" class="seccion">
  <h2>Marketplace</h2>
  <p>AquÃ­ irÃ¡ el marketplace.</p>
  <button onclick="mostrar('menuPrincipal')">Volver</button>
</div>

<div id="regalo" class="seccion">
  <h2>Regalo Diario</h2>
  <button onclick="darRegalo()">Reclamar</button>
  <p id="regaloMsg"></p>
  <button onclick="mostrar('menuPrincipal')">Volver</button>
</div>

<div id="tickets" class="seccion">
  <h2>Tickets</h2>
  <p>Tienes: <span id="ticketsCount2">0</span></p>
  <button onclick="comprarTicket()">Comprar Ticket (500 CarriCoins)</button>
  <button onclick="mostrar('menuPrincipal')">Volver</button>
</div>

<div id="objLista" class="seccion">
  <h2>Tu Inventario</h2>
  <div id="inventarioBox"></div>
  <button onclick="mostrar('menuPrincipal')">Volver</button>
</div>

<div id="juego" class="seccion">
  <h2>Mini juego</h2>
  <p>PrÃ³ximamente</p>
  <button onclick="mostrar('menuPrincipal')">Volver</button>
</div>

<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->
<!--        FIREBASE         -->
<!-- â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ -->

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyADVjuoLhcH34XPmZv-sx-eP71rIxVEKEY",
  authDomain: "juego-marketplace.firebaseapp.com",
  projectId: "juego-marketplace",
  storageBucket: "juego-marketplace-firebasestorage.app",
  messagingSenderId: "258620166110",
  appId: "1:258620166110:web:3a101d6f7743b6dbc6574f",
  databaseURL: "https://juego-marketplace-default-rtdb.firebaseio.com/"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let userActual = null;

function mostrar(id){
  document.querySelectorAll(".seccion").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

function crearCuenta(){
  let u = userInput.value.trim();
  let p = passInput.value.trim();
  if(!u || !p) return alert("Llene todo");

  db.ref("usuarios/"+u).set({
    pass:p,
    carriCoins:1500,
    tickets:3,
    inventario:[]
  });

  alert("Cuenta creada");
}

function iniciarSesion(){
  let u = userInput.value.trim();
  let p = passInput.value.trim();

  db.ref("usuarios/"+u).once("value", snap=>{
    if(!snap.exists()) return alert("No existe");

    let d=snap.val();
    if(d.pass !== p) return alert("ContraseÃ±a incorrecta");

    userActual = u;
    cargarDatos();
    mostrar("menuPrincipal");
  });
}

function cerrarSesion(){
  userActual=null;
  mostrar("menuInicio");
}

function cargarDatos(){
  db.ref("usuarios/"+userActual).on("value", snap=>{
    let d=snap.val();
    coinsCount.innerText = d.carriCoins;
    ticketsCount.innerText = d.tickets;
    ticketsCount2.innerText = d.tickets;
    saludo.innerText = "Bienvenido: " + userActual;

    inventarioBox.innerHTML = d.inventario.join(" ");
  });
}

/* --- Objetos y probabilidades --- */

const objetos = {
  comun: ["ğŸ»","ğŸº","ğŸ¶","ğŸ±","ğŸ¯"],
  poco: ["ğŸ¨","ğŸ¦","ğŸµ","ğŸ™‰","ğŸ®"],
  epico: ["ğŸ¦","ğŸ¦Š","ğŸ°","ğŸ­","ğŸ¹","ğŸ»â€â„ï¸"],
  mitico: ["ğŸ—½","ğŸ—¿","ğŸŒ¬ï¸","ğŸŒ€","ğŸŒªï¸"],
  legendario: ["ğŸ¦ ","ğŸª±","ğŸ›","ğŸŒŠ","ğŸŒ„"],
  ultra: ["ğŸ¤–","ğŸƒ","ğŸ‘¿","â›„","ğŸ‘º","â˜ ï¸"],
  xprn: ["ğŸ„","ğŸŒµ","ğŸŒ´","ğŸŒ³","ğŸŒ²"],
  toxtor: ["ğŸ¦•","ğŸ¦–","ğŸŠ","ğŸ","ğŸ¦"],
  gamma: ["ğŸ¦„","ğŸ—","ğŸ¦«","ğŸ¦¨","ğŸ¦‡","ğŸ¦œ"],
  dioses: ["ğŸ²","ğŸ¦","ğŸ¦š"],
  maestro: ["ğŸ•","ğŸ”¯","âœ¡ï¸","â˜¦ï¸","âœï¸","ğŸª¯","â˜ªï¸","â˜¯ï¸","â˜®ï¸","â˜¸ï¸","ğŸ•‰ï¸","ğŸ›","âš›ï¸"]
};

const probabilidades = {
  comun: 40,
  poco: 20,
  epico: 12,
  mitico: 8,
  legendario: 6,
  ultra: 5,
  xprn: 4,
  toxtor: 3,
  gamma: 1.3,
  dioses: 0.6,
  maestro: 0.1
};

function generarObjeto(){
  let total = 0;
  for(let r in probabilidades) total+=probabilidades[r];

  let random = Math.random()*total;
  let suma = 0;

  for(let r in probabilidades){
    suma+=probabilidades[r];
    if(random <= suma){
      let arr = objetos[r];
      return arr[Math.floor(Math.random()*arr.length)];
    }
  }
}

function darRegalo(){
  let obj = generarObjeto();

  db.ref("usuarios/"+userActual+"/inventario").get().then(s=>{
    let inv = s.val() || [];
    inv.push(obj);
    db.ref("usuarios/"+userActual+"/inventario").set(inv);
    regaloMsg.innerText="Ganaste: " + obj;
  });
}

function comprarTicket(){
  db.ref("usuarios/"+userActual).once("value", snap=>{
    let d=snap.val();

    if(d.carriCoins < 500)
      return alert("No tienes suficiente CarriCoins");

    db.ref("usuarios/"+userActual+"/carriCoins").set(d.carriCoins - 500);
    db.ref("usuarios/"+userActual+"/tickets").set(d.tickets + 1);
  });
}

/* --- CHAT --- */

db.ref("chat").on("value", snap=>{
  chatBox.innerHTML="";
  snap.forEach(m=>{
    chatBox.innerHTML+=m.val()+"<br>";
  });
});

function enviarMensaje(){
  let msg = userActual + ": " + chatMensaje.value;
  db.ref("chat").push(msg);
  chatMensaje.value="";
}

/* --- Jugadores activos + Top --- */

setInterval(()=>{
  db.ref("usuarios").once("value", snap=>{
    jugadoresActivos.innerHTML="";
    topGlobal.innerHTML="";
    rarezaBox.innerHTML = "";

    let arr=[];

    snap.forEach(u=>{
      let d=u.val();
      jugadoresActivos.innerHTML += `<div>${u.key}</div>`;
      arr.push({user:u.key, carriCoins:d.carriCoins});
    });

    arr.sort((a,b)=>b.carriCoins-a.carriCoins);

    arr.slice(0,10).forEach(t=>{
      topGlobal.innerHTML += `<div>${t.user}: ${t.carriCoins} CC</div>`;
    });

    for(let r in objetos){
      rarezaBox.innerHTML += `<div>${r}: ${objetos[r].join(" ")}</div>`;
    }
  });
},2000);
</script>

</body>
</html>
