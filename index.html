<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marketplace Meme Colombiano (Realtime)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f2f2f2;margin:0;padding:0;color:#111;text-align:center}
  .pantalla{display:none;padding:16px}
  button{padding:10px 12px;margin:6px;font-size:16px;cursor:pointer}
  #topCoins{font-size:20px;display:none;margin:10px 0}
  #juegoArea{width:90vw;max-width:420px;height:60vh;background:#222;margin:10px auto;position:relative;overflow:hidden;border-radius:8px}
  #player{width:10%;min-width:30px;height:10%;min-height:30px;background:#0f0;position:absolute;bottom:6%;left:45%}
  .cubo{width:10%;min-width:30px;height:10%;min-height:30px;background:red;position:absolute;top:0}
  #chatMensajes{height:220px;overflow:auto;border:1px solid #000;background:#fff;padding:6px;text-align:left;margin:8px 0}
  #invLista div,#objLista div,#histLista div,#listaVentas div,#chatMensajes div{margin:6px;padding:6px;border:1px solid #000;background:#fff}
  .botonesMovimiento button{width:30vw;max-width:140px;height:44px;font-size:20px;margin:6px}
  input,select{font-size:16px;padding:6px;margin:6px}
  .row{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
</style>
</head>
<body>

<h2 id="topCoins">CarriCoins: 0</h2>

<!-- LOGIN -->
<div id="login" class="pantalla" style="display:block">
  <h1>Iniciar sesi√≥n / Crear cuenta</h1>
  <input id="user" placeholder="Usuario" autocomplete="off"><br>
  <input id="pass" placeholder="Contrase√±a" type="password"><br>
  <button onclick="crearCuenta()">Crear cuenta (3 objetos comunes)</button>
  <button onclick="entrar()">Entrar</button>
</div>

<!-- MENU -->
<div id="menu" class="pantalla">
  <h1>Men√∫ Principal</h1>
  <div class="row">
    <button onclick="mostrar('juego')">Jugar: esquivar cubos</button>
    <button onclick="mostrar('market')">Marketplace</button>
  </div>
  <div class="row">
    <button onclick="mostrar('inventario')">Inventario</button>
    <button onclick="mostrar('historial')">Historial ventas</button>
  </div>
  <div class="row">
    <button onclick="mostrar('objLista')">Lista de objetos</button>
    <button onclick="mostrar('regalo')">Regalo (500 toques)</button>
  </div>
  <div class="row">
    <button onclick="mostrar('ruleta')">Ruleta</button>
    <button onclick="mostrar('chatPantalla')">Chat / Jugadores</button>
  </div>
</div>

<!-- JUEGO -->
<div id="juego" class="pantalla">
  <h2>Esquivar cubos</h2>
  <div id="juegoArea"><div id="player"></div></div>
  <p id="score">Puntos: 0</p>
  <div class="botonesMovimiento">
    <button onclick="mover(-10)">‚¨ÖÔ∏è</button>
    <button onclick="mover(10)">‚û°Ô∏è</button>
    <button id="pauseBtn">‚èπÔ∏è Pausar/Reanudar</button>
  </div>
  <div class="row">
    <button onclick="reiniciarCubos()">üîÑ Reiniciar (guardar puntos)</button>
    <button onclick="volverMenu()">Volver</button>
  </div>
</div>

<!-- MARKET -->
<div id="market" class="pantalla">
  <h2>Marketplace</h2>
  <h3>Vender</h3>
  <select id="sellItem"></select><br>
  <input id="sellPrice" placeholder="Precio en CarriCoins (n√∫mero)"><br>
  <button onclick="ponerEnVenta()">Poner en venta</button>
  <h3>Comprar (listado global)</h3>
  <div id="listaVentas"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- INVENTARIO -->
<div id="inventario" class="pantalla">
  <h2>Inventario</h2>
  <div id="invLista"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- HISTORIAL -->
<div id="historial" class="pantalla">
  <h2>Historial de ventas</h2>
  <div id="histLista"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- OBJETOS -->
<div id="objLista" class="pantalla">
  <h2>Objetos por rareza</h2>
  <div id="listaObjetos"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- REGALO -->
<div id="regalo" class="pantalla">
  <h2>Regalo</h2>
  <p>Toca 500 veces para recibir un objeto</p>
  <p id="toques">Toques: 0 / 500</p>
  <button id="tocarRegalo">üéÅ</button>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- RULETA -->
<div id="ruleta" class="pantalla">
  <h2>Ruleta de Objetos</h2>
  <p>Tickets disponibles: <span id="ticketCount">0</span></p>
  <button onclick="comprarTicket(1)">Comprar 1 Ticket (100 CC)</button>
  <button onclick="comprarTicket(10)">Paquete 10 Tickets (900 CC)</button><br>
  <button onclick="usarTicket()">Usar Ticket en Ruleta</button><br>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- CHAT Y JUGADORES -->
<div id="chatPantalla" class="pantalla">
  <h2>Chat Global</h2>
  <div id="chatMensajes"></div>
  <input id="chatInput" placeholder="Escribe tu mensaje" style="width:70%">
  <button onclick="enviarMensaje()">Enviar</button>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
  <h3>Jugadores activos</h3>
  <div id="jugadoresActivos"></div>
  <h3>Top CarriCoins</h3>
  <div id="topDinero"></div>
</div>

<!-- =================== SCRIPT PRINCIPAL (TU L√ìGICA) =================== -->
<script>
/* Variables locales (se usan como cache/backup). Con Firebase sincronizaremos todo. */
let localDB = {}; // NO confundir con Firebase
let userActual = null;
let puntos = 0;
let cubosActivos = [];
let intervalo = null;
let juegoPausado = false;
let toques = 0;
let ventasLocal = []; // no obligatorio, usamos Firebase
let player = document.getElementById('player');
let chatMensajes = [];

/* Objetos (lista que usaremos para sacar aleatorios) */
let objetosRangos = [
  {nombre:"ü¶ß Goriloco-Banan√≠n",rango:"Com√∫n"},{nombre:"üê∏ PepeSaltarin",rango:"Com√∫n"},{nombre:"üêî PolloNoob",rango:"Com√∫n"},
  {nombre:"üê¢ TortuSpeed",rango:"Com√∫n"},{nombre:"üêç SnekGamer",rango:"Com√∫n"},{nombre:"üêÅ Rat√≥nFail",rango:"Com√∫n"},{nombre:"üêô PulpoBrainrot",rango:"Com√∫n"},
  {nombre:"üê≤ Drag√≥nThug",rango:"Raro"},{nombre:"ü¶ç MonoBruh",rango:"Raro"},{nombre:"ü¶ñ T-RexEpicFail",rango:"Raro"},{nombre:"ü¶Å Le√≥nMood",rango:"Raro"},
  {nombre:"ü¶ä ZorroCringe",rango:"Raro"},{nombre:"üêß PenguinoXD",rango:"Raro"},{nombre:"üêµ MonoChad",rango:"Raro"},
  {nombre:"üêô PulpoOver9000",rango:"√âpico"},{nombre:"ü¶Ñ Unic√≥rnitoLOL",rango:"√âpico"},{nombre:"üê∫ LoboSus",rango:"√âpico"},{nombre:"üêâ Drag√≥nYeet",rango:"√âpico"},
  {nombre:"ü¶å RenoBruhMoment",rango:"√âpico"},{nombre:"üê¥ CaballoCringe",rango:"√âpico"},{nombre:"ü¶Ä CrabbyMad",rango:"√âpico"},
  {nombre:"üëë ReyCarritoSus",rango:"Legendario"},{nombre:"üêâ DragonCarroYeet",rango:"Legendario"},{nombre:"ü¶Ñ Unic√≥rnitoBruh",rango:"Legendario"},
  {nombre:"ü¶ñ T-RexChad",rango:"Legendario"},{nombre:"üê≤ Drag√≥nEpicFail",rango:"Legendario"},{nombre:"üêâ F√©nixLOL",rango:"Legendario"},{nombre:"üêâ HydraSus",rango:"Legendario"},
  {nombre:"üê≤ Drag√≥nFinalYeet",rango:"UltraLegendario"},{nombre:"üêâ F√©nixCarroLOL",rango:"UltraLegendario"},{nombre:"üêâ HydraUltraBruh",rango:"UltraLegendario"},{nombre:"üëë CarritoSupremoEpic",rango:"UltraLegendario"},
  {nombre:"ü¶Ñ Unic√≥rnitoOP",rango:"UltraLegendario"},{nombre:"üëπ MemeDios",rango:"Dioses"}
];

/* ----- FUNCIONES UI y HELPERS ----- */
function mostrar(id){
  document.querySelectorAll('.pantalla').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
  if(id==="objLista") mostrarListaObjetos();
  actualizarJugadoresUI();
}
function volverMenu(){mostrar('menu');}
function actualizarTopCoinsUI(coins){ document.getElementById('topCoins').innerText="CarriCoins: "+coins; document.getElementById('topCoins').style.display='block'; }

/* ----- FUNCIONES DEL JUEGO (id√©nticas a lo que ya ten√≠as) ----- */
function crearCuenta(){
  let user=document.getElementById('user').value.trim();
  let pass=document.getElementById('pass').value.trim();
  if(!user||!pass){alert("Usuario y contrase√±a requeridos"); return;}
  // crear en Firebase (ver seccion firebase abajo)
  crearUsuarioFirebase(user,pass);
}

function entrar(){
  let user=document.getElementById('user').value.trim();
  let pass=document.getElementById('pass').value.trim();
  if(!user||!pass){alert("Ingresa usuario y contrase√±a"); return;}
  loginFirebase(user,pass);
}

function actualizarInventarioUI(items){
  let inv=document.getElementById('invLista'); inv.innerHTML="";
  items.forEach(o=>{ let d=document.createElement('div'); d.innerText=o.nombre+" ("+o.rango+")"; inv.appendChild(d); });
  let sell=document.getElementById('sellItem'); sell.innerHTML="";
  items.forEach((o,i)=>{ let option=document.createElement('option'); option.value=i; option.text=o.nombre+" ("+o.rango+")"; sell.appendChild(option);});
}

function ponerEnVenta(){
  let sel=document.getElementById('sellItem'); let index=sel.value;
  let precio=parseInt(document.getElementById('sellPrice').value);
  if(isNaN(precio)||precio<=0){alert("Precio inv√°lido"); return;}
  ponerVentaFirebase(index,precio);
}

function actualizarMarketUI(listado){
  let lista=document.getElementById('listaVentas'); lista.innerHTML="";
  listado.forEach(v=>{
    let d=document.createElement('div');
    let accion = (v.vendedor!==userActual) ? `<button onclick='comprarFirebase("${v.key}")'>Comprar</button>` : "[Tu objeto]";
    d.innerHTML = `${v.nombre} (${v.rango}) - ${v.precio} CC - ${v.vendedor} ${accion}`;
    lista.appendChild(d);
  });
}

function comprarFirebase(key){
  comprarVentaFirebase(key);
}

function actualizarHistorialUI(hist){
  let h=document.getElementById('histLista'); h.innerHTML="";
  hist.forEach(tr=>{ let d=document.createElement('div'); d.innerText=`Vendiste ${tr.vendido} por ${tr.precio} CC`; h.appendChild(d);});
}

function mostrarListaObjetos(){
  let lista=document.getElementById('listaObjetos'); lista.innerHTML="";
  objetosRangos.forEach(o=>{ let d=document.createElement('div'); d.innerText=o.nombre+" ("+o.rango+")"; lista.appendChild(d); });
}

/* Movimiento player */
function mover(x){ let posPercent = parseFloat(player.style.left)||45; posPercent+=x; if(posPercent<0) posPercent=0; if(posPercent>80) posPercent=80; player.style.left=posPercent+"%"; }

/* Minijuego */
function reiniciarCubos(){ 
  if(!userActual){ alert("Debes iniciar sesi√≥n para guardar CarriCoins"); puntos=0; document.getElementById('score').innerText="Puntos: 0"; limpiarCubos(); return; }
  // guardar puntos en cuenta (sumar coins)
  sumarCoinsFirebase(puntos);
  puntos=0; document.getElementById('score').innerText="Puntos: 0"; limpiarCubos(); if(!juegoPausado) iniciarCubos();
}
function limpiarCubos(){ cubosActivos.forEach(c=>c.remove()); cubosActivos=[]; clearInterval(intervalo); }
function iniciarCubos(){
  clearInterval(intervalo);
  intervalo=setInterval(()=>{
    if(Math.random()<0.02){
      let cubo=document.createElement('div'); cubo.className='cubo'; cubo.style.left=Math.random()*80+'%'; cubo.style.top='0%';
      document.getElementById('juegoArea').appendChild(cubo); cubosActivos.push(cubo);
    }
    cubosActivos.forEach((c,i)=>{
      let top=parseFloat(c.style.top); c.style.top=(top+0.5)+'%';
      let pL=parseFloat(player.style.left), pR=pL+10, pT=90, pB=100, cL=parseFloat(c.style.left), cR=cL+10, cT=parseFloat(c.style.top), cB=cT+10;
      if(!(pR<cL||pL>cR||pB<cT||pT>cB)){
        // choque
        if(userActual) sumarCoinsFirebase(puntos);
        alert("Te chocaste! Ganaste "+puntos+" CarriCoins");
        reiniciarCubos();
      }
      if(cT>100){ c.remove(); cubosActivos.splice(i,1); puntos++; document.getElementById('score').innerText="Puntos: "+puntos; }
    });
  },20);
}

/* Pausa */
document.getElementById('pauseBtn').addEventListener('click', ()=>{
  if(!juegoPausado){ clearInterval(intervalo); juegoPausado=true; alert("Juego pausado ‚èπÔ∏è"); }
  else{ iniciarCubos(); juegoPausado=false; alert("Juego reanudado ‚ñ∂Ô∏è"); }
});

/* Regalo 500 toques */
document.getElementById('tocarRegalo').addEventListener('click', ()=>{
  toques++; document.getElementById('toques').innerText = toques + " / 500";
  if(toques>=500){
    if(!userActual){ alert("Inicia sesi√≥n para recibir el objeto"); toques=0; document.getElementById('toques').innerText = toques + " / 500"; return; }
    obtenerObjetoFirebase().then(obj=>{
      agregarObjetoAUsuarioFirebase(obj);
      alert("¬°Recibiste un objeto del regalo!: "+obj.nombre);
    });
    toques=0; document.getElementById('toques').innerText = toques + " / 500";
  }
});

/* RULETA y tickets */
function comprarTicket(cant){
  if(!userActual){ alert("Inicia sesi√≥n para comprar tickets"); return; }
  let precio = cant==1?100:900;
  comprarTicketsFirebase(cant,precio);
}
function usarTicket(){
  usarTicketFirebase();
}

/* Chat local UI (se actualiza desde Firebase) */
function mostrarChatUI(mensajes){
  let chatDiv = document.getElementById('chatMensajes'); chatDiv.innerHTML = "";
  mensajes.forEach(m=>{
    let d = document.createElement('div');
    d.innerText = m.usuario + ": " + m.texto;
    chatDiv.appendChild(d);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

/* Jugadores y top UI (actualizaci√≥n desde Firebase) */
function actualizarJugadoresUI(usuarios){
  let jugadoresDiv=document.getElementById('jugadoresActivos'); jugadoresDiv.innerHTML="";
  let topDiv=document.getElementById('topDinero'); topDiv.innerHTML="";
  if(!usuarios) return;
  let list = Object.keys(usuarios).map(u=>({usuario:u,coins:usuarios[u].coins||0}));
  list.forEach(item=>{
    let d=document.createElement('div'); d.innerText = item.usuario; jugadoresDiv.appendChild(d);
  });
  list.sort((a,b)=>b.coins-a.coins);
  list.slice(0,10).forEach(t=>{
    let d=document.createElement('div'); d.innerText = t.usuario + ": " + t.coins + " CC"; topDiv.appendChild(d);
  });
}

/* Reset chat local cada 3 minutos: la versi√≥n en Firebase tambi√©n limpia en servidor (ver abajo) */
setInterval(()=>{ /* local placeholder */ }, 180000);

/* =================== FIREBASE: configuraci√≥n y funciones =================== */
/* REEMPLAZA el firebaseConfig por el tuyo si es necesario. Ya viene con el tuyo. */
</script>

<!-- =================== FIREBASE (NO DUPLICAR, este bloque VA DESPUES del script anterior) =================== -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyADVjuoLhcH34XPmZv-sx-eP71rIxVEKEY",
    authDomain: "juego-marketplace.firebaseapp.com",
    databaseURL: "https://juego-marketplace-default-rtdb.firebaseio.com/",
    projectId: "juego-marketplace",
    storageBucket: "juego-marketplace.firebasestorage.app",
    messagingSenderId: "258620166110",
    appId: "1:258620166110:web:3a101d6f7743b6dbc6574f",
    measurementId: "G-0GZDE8FNEC"
  };

  // Inicializar Firebase (compat)
  firebase.initializeApp(firebaseConfig);
  const rtdb = firebase.database();

  // Helpers de referencia
  const refUsuarios = rtdb.ref('usuarios');     // usuarios/{user}
  const refChat = rtdb.ref('chat');             // chat/{pushId}
  const refVentas = rtdb.ref('ventas');         // ventas/{pushId}

  /* ---------- ESCUCHAS EN TIEMPO REAL ---------- */

  // 1) Escuchar chat (todos los mensajes)
  refChat.on('value', snap=>{
    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(k=>({key:k, usuario: obj[k].usuario, texto: obj[k].texto, ts: obj[k].ts})).sort((a,b)=>a.ts-b.ts);
    chatMensajes = arr;
    mostrarChatUI(arr);
  });

  // 2) Escuchar ventas (marketplace)
  refVentas.on('value', snap=>{
    const obj = snap.val() || {};
    const arr = Object.keys(obj).map(k=>({key:k, vendedor: obj[k].vendedor, nombre: obj[k].nombre, precio: obj[k].precio, rango: obj[k].rango}));
    actualizarMarketUI(arr);
  });

  // 3) Escuchar usuarios para top y jugadores activos
  refUsuarios.on('value', snap=>{
    const obj = snap.val() || {};
    actualizarJugadoresUI(obj);
  });

  /* ---------- FUNCIONES QUE USAN FIREBASE ---------- */

  // Crear usuario (si no existe) y darle 3 objetos comunes y 50 coins
  function crearUsuarioFirebase(user, pass){
    if(!user) return;
    refUsuarios.child(user).get().then(snap=>{
      if(snap.exists()){ alert("Usuario ya existe"); return; }
      // crear y asignar 3 comunes aleatorios
      const comunes = objetosRangos.filter(o=>o.rango==="Com√∫n");
      let objetos = [];
      for(let i=0;i<3;i++) objetos.push(comunes[Math.floor(Math.random()*comunes.length)]);
      const data = { pass: pass, coins: 50, objetos: objetos, historial: [], tickets: 0 };
      refUsuarios.child(user).set(data).then(()=>{
        alert("Cuenta creada con 3 objetos comunes y 50 CarriCoins");
      });
    });
  }

  // Login
  function loginFirebase(user,pass){
    if(!user) return;
    refUsuarios.child(user).get().then(snap=>{
      if(!snap.exists() || snap.val().pass !== pass){ alert("Usuario o contrase√±a incorrectos"); return; }
      userActual = user;
      // cargar UI con lo que haya
      const data = snap.val();
      actualizarTopCoinsUI(data.coins||0);
      actualizarInventarioUI(data.objetos||[]);
      actualizarHistorialUI(data.historial||[]);
      document.getElementById('ticketCount').innerText = data.tickets || 0;
      mostrar('menu');
      // marcar presencia simple: escribir √∫ltimo ping
      refUsuarios.child(user).update({ lastSeen: Date.now() });
    });
  }

  // Sumar coins al usuario (por puntos del minijuego)
  function sumarCoinsFirebase(amount){
    if(!userActual) return;
    const userRef = refUsuarios.child(userActual);
    userRef.get().then(snap=>{
      const cur = (snap.exists() && snap.val().coins) ? snap.val().coins : 0;
      userRef.update({ coins: cur + (amount||0) }).then(()=>{
        // refrescar UI
        refUsuarios.child(userActual).get().then(snap2=>{
          const d = snap2.val();
          actualizarTopCoinsUI(d.coins||0);
        });
      });
    });
  }

  // Poner en venta un objeto (usa el √≠ndice del inventario)
  function ponerVentaFirebase(index, precio){
    if(!userActual){ alert("Inicia sesi√≥n"); return; }
    refUsuarios.child(userActual).get().then(snap=>{
      const data = snap.val();
      if(!data || !data.objetos || !data.objetos[index]){ alert("Objeto inv√°lido"); return; }
      const obj = data.objetos[index];
      // eliminar del inventario del usuario
      data.objetos.splice(index,1);
      refUsuarios.child(userActual).update({ objetos: data.objetos, historial: data.historial||[] }).then(()=>{
        // crear venta en nodo ventas
        const venta = { vendedor: userActual, nombre: obj.nombre, precio: precio, rango: obj.rango };
        refVentas.push(venta);
      });
    });
  }

  // Comprar venta por key
  function comprarVentaFirebase(key){
    if(!userActual){ alert("Inicia sesi√≥n"); return; }
    refVentas.child(key).get().then(snap=>{
      if(!snap.exists()){ alert("Venta no existe"); return; }
      const venta = snap.val();
      if(venta.vendedor === userActual){ alert("No puedes comprar tu propio objeto"); return; }
      // leer comprador y vendedor balances
      refUsuarios.child(userActual).get().then(buySnap=>{
        const buyer = buySnap.val();
        if((buyer.coins||0) < venta.precio){ alert("No tienes suficientes CarriCoins"); return; }
        // transferir
        const newBuyerCoins = (buyer.coins||0) - venta.precio;
        refUsuarios.child(userActual).update({ coins: newBuyerCoins }).then(()=>{
          // agregar objeto al comprador
          refUsuarios.child(userActual).get().then(bSnap2=>{
            const bdata = bSnap2.val();
            const arr = bdata.objetos || [];
            arr.push({ nombre: venta.nombre, rango: venta.rango });
            refUsuarios.child(userActual).update({ objetos: arr }).then(()=>{
              // agregar dinero al vendedor y registrar historial
              refUsuarios.child(venta.vendedor).get().then(snapVend=>{
                const vendData = snapVend.val() || {};
             <button onclick="mostrar('market')">Marketplace</button><br>
<button onclick="mostrar('inventario')">Inventario</button><br>
<button onclick="mostrar('historial')">Historial de ventas</button><br>
<button onclick="mostrar('objLista')">Lista de objetos</button><br>
<button onclick="mostrar('regalo')">Abrir regalo (500 toques)</button><br>
<button onclick="mostrar('ruleta')">Ruleta de objetos</button><br>
<button onclick="mostrar('chatPantalla')">Chat Global / Jugadores</button>
</div>

<div id="juego" class="pantalla">
<h2>Esquivar cubos</h2>
<div id="juegoArea">
<div id="player"></div>
</div>
<p id="score">Puntos: 0</p>
<div class="botonesMovimiento">
<button onclick="mover(-10)">‚¨ÖÔ∏è</button>
<button onclick="mover(10)">‚û°Ô∏è</button>
<button id="pauseBtn">‚èπÔ∏è Pausar/Reanudar</button>
</div>
<button onclick="reiniciarCubos()">üîÑ Reiniciar Cubos</button><br>
<button onclick="volverMenu()">Volver al men√∫</button>
</div>

<div id="market" class="pantalla">
<h2>Marketplace</h2>
<h3>Vender</h3>
<select id="sellItem"></select><br>
<input id="sellPrice" placeholder="Precio en CarriCoins"><br>
<button onclick="ponerEnVenta()">Poner en venta</button>
<h3>Comprar</h3>
<div id="listaVentas"></div>
<button onclick="volverMenu()">Volver</button>
</div>

<div id="inventario" class="pantalla">
<h2>Inventario</h2>
<div id="invLista"></div>
<button onclick="volverMenu()">Volver</button>
</div>

<div id="historial" class="pantalla">
<h2>Historial</h2>
<div id="histLista"></div>
<button onclick="volverMenu()">Volver</button>
</div>

<div id="objLista" class="pantalla">
<h2>Objetos por rareza</h2>
<div id="listaObjetos"></div>
<button onclick="volverMenu()">Volver</button>
</div>

<div id="regalo" class="pantalla">
<h2>Regalo</h2>
<p>Toca 500 veces para recibir un objeto</p>
<p id="toques">Toques: 0 / 500</p>
<button id="tocarRegalo">üéÅ</button>
<button onclick="volverMenu()">Volver</button>
</div>

<div id="ruleta" class="pantalla">
<h2>Ruleta de Objetos</h2>
<p>Tickets disponibles: <span id="ticketCount">0</span></p>
<button onclick="comprarTicket(1)">Comprar 1 Ticket (100 CC)</button>
<button onclick="comprarTicket(10)">Paquete 10 Tickets (900 CC)</button><br>
<button onclick="usarTicket()">Usar Ticket en Ruleta</button><br>
<button onclick="volverMenu()">Volver</button>
</div>

<div id="chatPantalla" class="pantalla">
<h2>Chat Global</h2>
<div id="chatMensajes"></div>
<input id="chatInput" placeholder="Escribe tu mensaje" style="width:70%;">
<button onclick="enviarMensaje()">Enviar</button><br>
<button onclick="volverMenu()">Volver</button>
<h3>Jugadores activos</h3>
<div id="jugadoresActivos"></div>
<h3>Top CarriCoins</h3>
<div id="topDinero"></div>
</div>

<script>
// Base de datos
let db = JSON.parse(localStorage.getItem("db")) || {};
let userActual = localStorage.getItem("userActual") || null;
let puntos = 0;
let cubosActivos = [];
let intervalo = null;
let juegoPausado = false;
let toques = 0;
let ventas = [];
let player = document.getElementById('player');
let chatMensajes = [];

// Objetos
let objetosRangos = [
{nombre:"ü¶ß Goriloco-Banan√≠n",rango:"Com√∫n"},{nombre:"üê∏ PepeSaltarin",rango:"Com√∫n"},{nombre:"üêî PolloNoob",rango:"Com√∫n"},{nombre:"üê¢ TortuSpeed",rango:"Com√∫n"},{nombre:"üêç SnekGamer",rango:"Com√∫n"},
{nombre:"üêÅ Rat√≥nFail",rango:"Com√∫n"},{nombre:"üêô PulpoBrainrot",rango:"Com√∫n"},{nombre:"üê≤ Drag√≥nThug",rango:"Raro"},{nombre:"ü¶ç MonoBruh",rango:"Raro"},{nombre:"ü¶ñ T-RexEpicFail",rango:"Raro"},
{nombre:"ü¶Å Le√≥nMood",rango:"Raro"},{nombre:"ü¶ä ZorroCringe",rango:"Raro"},{nombre:"üêß PenguinoXD",rango:"Raro"},{nombre:"üêµ MonoChad",rango:"Raro"},
{nombre:"üêô PulpoOver9000",rango:"√âpico"},{nombre:"ü¶Ñ Unic√≥rnitoLOL",rango:"√âpico"},{nombre:"üê∫ LoboSus",rango:"√âpico"},{nombre:"üêâ Drag√≥nYeet",rango:"√âpico"},{nombre:"ü¶å RenoBruhMoment",rango:"√âpico"},{nombre:"üê¥ CaballoCringe",rango:"√âpico"},{nombre:"ü¶Ä CrabbyMad",rango:"√âpico"},
{nombre:"üëë ReyCarritoSus",rango:"Legendario"},{nombre:"üêâ DragonCarroYeet",rango:"Legendario"},{nombre:"ü¶Ñ Unic√≥rnitoBruh",rango:"Legendario"},{nombre:"ü¶ñ T-RexChad",rango:"Legendario"},{nombre:"üê≤ Drag√≥nEpicFail",rango:"Legendario"},{nombre:"üêâ F√©nixLOL",rango:"Legendario"},{nombre:"üêâ HydraSus",rango:"Legendario"},
{nombre:"üê≤ Drag√≥nFinalYeet",rango:"UltraLegendario"},{nombre:"üêâ F√©nixCarroLOL",rango:"UltraLegendario"},{nombre:"üêâ HydraUltraBruh",rango:"UltraLegendario"},{nombre:"üëë CarritoSupremoEpic",rango:"UltraLegendario"},{nombre:"ü¶Ñ Unic√≥rnitoOP",rango:"UltraLegendario"},{nombre:"üëπ MemeDios",rango:"Dioses"}];

// Funciones generales
function guardarDB(){localStorage.setItem("db", JSON.stringify(db)); localStorage.setItem("userActual", userActual);}
function mostrar(id){document.querySelectorAll('.pantalla').forEach(p=>p.style.display='none'); document.getElementById(id).style.display='block'; if(id==="objLista") mostrarListaObjetos(); actualizarJugadores();}
function volverMenu(){mostrar('menu');}
function actualizarCoins(){if(userActual) document.getElementById('topCoins').innerText="CarriCoins: "+db[userActual].coins; document.getElementById('topCoins').style.display='block';}

// Crear cuenta con 3 objetos comunes
function crearCuenta(){
  let user=document.getElementById('user').value;
  let pass=document.getElementById('pass').value;
  if(!user||!pass){alert("Usuario y contrase√±a requeridos"); return;}
  if(db[user]){alert("Usuario ya existe"); return;}
  db[user]={pass:pass,coins:50,objetos:[],historial:[],tickets:0};
  let comunes = objetosRangos.filter(o=>o.rango==="Com√∫n");
  for(let i=0;i<3;i++){ db[user].objetos.push(comunes[Math.floor(Math.random()*comunes.length)]); }
  guardarDB();
  alert("Cuenta creada con 3 objetos comunes y 50 CarriCoins");
}

// Entrar
function entrar(){
  let user=document.getElementById('user').value;
  let pass=document.getElementById('pass').value;
  if(!db[user]||db[user].pass!==pass){alert("Usuario o contrase√±a incorrectos"); return;}
  userActual=user; actualizarCoins(); actualizarInventario(); actualizarHistorial(); document.getElementById('ticketCount').innerText=db[userActual].tickets; guardarDB(); mostrar('menu');
}

// Inventario
function actualizarInventario(){
  let inv=document.getElementById('invLista'); inv.innerHTML="";
  db[userActual].objetos.forEach((o,i)=>{let d=document.createElement('div'); d.innerText=o.nombre+" ("+o.rango+")"; inv.appendChild(d);});
  let sell=document.getElementById('sellItem'); sell.innerHTML="";
  db[userActual].objetos.forEach((o,i)=>{let option=document.createElement('option'); option.value=i; option.text=o.nombre+" ("+o.rango+")"; sell.appendChild(option);});
  actualizarMarket(); guardarDB();
}

function ponerEnVenta(){
  let sel=document.getElementById('sellItem'); let index=sel.value;
  let precio=parseInt(document.getElementById('sellPrice').value);
  if(isNaN(precio)||precio<=0){alert("Precio inv√°lido"); return;}
  let obj=db[userActual].objetos.splice(index,1)[0];
  ventas.push({vendedor:userActual,nombre:obj.nombre,precio:precio,objeto:obj});
  actualizarInventario(); actualizarMarket(); alert("Objeto puesto a la venta");
}

function actualizarMarket(){
  let lista=document.getElementById('listaVentas'); lista.innerHTML="";
  ventas.forEach((v,i)=>{
    let d=document.createElement('div');
    d.innerHTML=v.nombre+" ("+v.objeto.rango+") - "+v.precio+" CC "+(v.vendedor!==userActual? "<button onclick='comprar("+i+")'>Comprar</button>":"[Tu objeto]");
    lista.appendChild(d);
  });
}

function comprar(i){
  let v=ventas[i];
  if(db[userActual].coins<v.precio){alert("No tienes suficientes CarriCoins"); return;}
  db[userActual].coins-=v.precio; db[v.vendedor].coins+=v.precio;
  db[userActual].objetos.push(v.objeto);
  db[v.vendedor].historial.push({vendido:v.nombre,precio:v.precio});
  ventas.splice(i,1);
  actualizarCoins(); actualizarInventario(); actualizarMarket(); alert("Compra exitosa");
}

function actualizarHistorial(){
  let h=document.getElementById('histLista'); h.innerHTML="";
  db[userActual].historial.forEach(tr=>{let d=document.createElement('div'); d.innerText="Vendiste "+tr.vendido+" por "+tr.precio+" CC"; h.appendChild(d);});
}

function mostrarListaObjetos(){
  let lista=document.getElementById('listaObjetos'); lista.innerHTML="";
  objetosRangos.forEach(o=>{let d=document.createElement('div'); d.innerText=o.nombre+" ("+o.rango+")"; lista.appendChild(d);});
}

// Movimiento player
function mover(x){let pos=parseFloat(player.style.left)||45; pos+=x; if(pos<0) pos=0; if(pos>80) pos=80; player.style.left=pos+"%";}

// Minijuego y reinicio de cubos
function reiniciarCubos(){ db[userActual].coins += puntos; actualizarCoins(); puntos=0; document.getElementById('score').innerText="Puntos: 0"; cubosActivos.forEach(c=>c.remove()); cubosActivos=[]; clearInterval(intervalo); if(!juegoPausado) iniciarCubos();}
function iniciarCubos(){
  clearInterval(intervalo);
  intervalo=setInterval(()=>{
    if(Math.random()<0.02){
      let cubo=document.createElement('div'); cubo.className="cubo"; cubo.style.left=Math.random()*80+"%"; cubo.style.top="0%";
      document.getElementById('juegoArea').appendChild(cubo); cubosActivos.push(cubo);
    }
    cubosActivos.forEach((c,i)=>{
      let top=parseFloat(c.style.top); c.style.top=(top+0.5)+"%";
      let pL=parseFloat(player.style.left), pR=pL+10, pT=90, pB=100, cL=parseFloat(c.style.left), cR=cL+10, cT=parseFloat(c.style.top), cB=cT+10;
      if(!(pR<cL||pL>cR||pB<cT||pT>cB)){
        db[userActual].coins += puntos; actualizarCoins();
        alert("Te chocaste! Ganaste "+puntos+" CarriCoins");
        reiniciarCubos();
      }
      if(cT>100){c.remove(); cubosActivos.splice(i,1); puntos++; document.getElementById('score').innerText="Puntos: "+puntos;}
    });
  },20);
}

// Bot√≥n pausa/reanuda
document.getElementById('pauseBtn').addEventListener('click', ()=>{
  if(!juegoPausado){ clearInterval(intervalo); juegoPausado=true; alert("Juego pausado ‚èπÔ∏è"); }
  else { iniciarCubos(); juegoPausado=false; alert("Juego reanudado ‚ñ∂Ô∏è"); }
});

// Regalo 500 toques
document.getElementById('tocarRegalo').addEventListener('click',()=>{
  toques++; document.getElementById('toques').innerText=toques+" / 500";
  if(toques>=500){
    let obj=objetosRangos[Math.floor(Math.random()*objetosRangos.length)];
    db[userActual].objetos.push(obj); actualizarInventario();
    alert("¬°Recibiste un objeto del regalo!: "+obj.nombre);
    toques=0; document.getElementById('toques').innerText=toques+" / 500";
  }
});

// Tickets ruleta
function comprarTicket(cant){ let precio=cant==1?100:900; if(db[userActual].coins<precio){alert("No tienes CarriCoins"); return;} db[userActual].coins-=precio; db[userActual].tickets+=cant; document.getElementById('ticketCount').innerText=db[userActual].tickets; actualizarCoins(); guardarDB();}
function usarTicket(){ if(db[userActual].tickets<1){alert("No tienes tickets"); return;} db[userActual].tickets--; document.getElementById('ticketCount').innerText=db[userActual].tickets; let obj=objetosRangos[Math.floor(Math.random()*objetosRangos.length)]; db[userActual].objetos.push(obj); actualizarInventario(); alert("¬°Ganaste en la ruleta!: "+obj.nombre);}

// Chat Global
function enviarMensaje(){
  let msg=document.getElementById('chatInput').value.trim();
  if(msg==="") return;
  chatMensajes.push(userActual+": "+msg);
  document.getElementById('chatInput').value="";
  mostrarChat();
}

function mostrarChat(){
  let chatDiv=document.getElementById('chatMensajes');
  chatDiv.innerHTML="";
  chatMensajes.forEach(m=>{ let d=document.createElement('div'); d.innerText=m; chatDiv.appendChild(d); });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// Jugadores activos y top dinero
function actualizarJugadores(){
  let jugadoresDiv=document.getElementById('jugadoresActivos');
  jugadoresDiv.innerHTML="";
  Object.keys(db).forEach(u=>{ let d=document.createElement('div'); d.innerText=u; jugadoresDiv.appendChild(d); });
  let topDiv=document.getElementById('topDinero');
  // Top CarriCoins
  let topJugadores = Object.keys(db).map(u => ({usuario: u, coins: db[u].coins}));
  topJugadores.sort((a,b) => b.coins - a.coins);
  topDiv.innerHTML = "";
  topJugadores.slice(0,10).forEach(t => {
    let d = document.createElement('div');
    d.innerText = t.usuario + ": " + t.coins + " CC";
    topDiv.appendChild(d);
  });
}

// Actualizar cada 3 minutos el chat y jugadores activos
setInterval(() => {
  chatMensajes = []; // Resetea chat cada 3 minutos
  mostrarChat();
  actualizarJugadores();
}, 180000);

  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
  import { getDatabase } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyADVjuoLhcH34XPmZv-sx-eP71rIxVEKEY",
    authDomain: "juego-marketplace.firebaseapp.com",
    projectId: "juego-marketplace",
    storageBucket: "juego-marketplace.firebasestorage.app",
    messagingSenderId: "258620166110",
    appId: "1:258620166110:web:3a101d6f7743b6dbc6574f",
    measurementId: "G-0GZDE8FNEC",
    databaseURL: "https://juego-marketplace-default-rtdb.firebaseio.com/"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  console.log("üî• Firebase conectado correctamente");
</script>
// Inicializaci√≥n si ya hay usuario logueado
if(userActual) {
  actualizarCoins();
  actualizarInventario();
  actualizarHistorial();
  document.getElementById('ticketCount').innerText = db[userActual].tickets;
  mostrar('menu');
}
</script>
</body>
</html>
  
