<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marketplace Juego - Completo</title>
<style>
  :root{--bg:#f3f4f6;--card:#fff;--accent:#0b8;--muted:#666}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;color:#111}
  header{background:#0b8;padding:12px;color:#fff;text-align:center;font-weight:700}
  .app{max-width:1000px;margin:18px auto;padding:12px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .card{background:var(--card);padding:10px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .row{display:flex;gap:8px;align-items:center}
  button{cursor:pointer;padding:8px 10px;border-radius:6px;border:0;background:#0b8;color:#fff}
  input,select{padding:8px;border:1px solid #ddd;border-radius:6px;width:100%}
  label{font-size:13px;color:var(--muted)}
  #juegoArea{height:280px;background:#111;border-radius:6px;position:relative;overflow:hidden}
  #player{position:absolute;left:45%;bottom:10%;width:10%;min-width:40px;height:12%;min-height:40px;background:#4caf50;border-radius:6px}
  .cubo{position:absolute;width:10%;min-width:30px;height:12%;min-height:30px;background:red;border-radius:6px}
  #chatMensajes{height:220px;overflow:auto;border:1px solid #eee;padding:8px;background:#fafafa;border-radius:6px}
  .small{font-size:13px;color:var(--muted)}
  .obj{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:6px;background:#fff;border:1px solid #eee;margin-bottom:6px}
  .badge{padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .rare-ComÃºn{background:#e6f7e6;color:#1b5e20}
  .rare-Raro{background:#e8f0ff;color:#0b47a1}
  .rare-Ã‰pico{background:#fff0e6;color:#a14b00}
  .rare-Legendario{background:#f7e6ff;color:#5a0270}
  .rare-UltraLegendario{background:#fff5e6;color:#7a3600}
  .rare-OP{background:#ffe6e6;color:#7a0000}
  .rare-Dioses{background:#fff8e6;color:#8a5a00}
  .mut{opacity:.9;padding:2px 6px;border-radius:6px;background:#222;color:#fff;margin-left:6px}
  footer{text-align:center;padding:10px;font-size:13px;color:var(--muted)}
  @media (max-width:900px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<header>Marketplace Juego â€” Realtime</header>

<div class="app">

  <div class="card" id="loginCard">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="inputUser" placeholder="Usuario" />
      <input id="inputPass" placeholder="ContraseÃ±a" type="password" />
      <button id="btnCreate">Crear cuenta</button>
      <button id="btnLogin">Entrar</button>
      <button id="btnLogout" style="display:none;background:#f55">Salir</button>
    </div>
    <div class="small" style="margin-top:8px">Si creas cuenta recibes 3 objetos comunes y 50 CarriCoins.</div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div>

      <!-- TOP BAR -->
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">Usuario: <span id="meUser">â€”</span></div>
          <div class="small">Coins: <span id="meCoins">0</span> Â· Tickets: <span id="meTickets">0</span></div>
        </div>
        <div style="text-align:right">
          <div class="small">Activos: <span id="activeCount">0</span></div>
          <div class="small">Chat resetea cada 3 min</div>
        </div>
      </div>

      <!-- Juego / Minijuego simple con puntos -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Minijuego: Esquivar cubos</strong><div class="small">Gana puntos, conviÃ©rtelos en CarriCoins al reiniciar.</div></div>
          <div id="scoreBox">Puntos: <strong id="scoreVal">0</strong></div>
        </div>

        <div id="juegoArea" style="margin-top:10px">
          <div id="player"></div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="leftBtn">â¬…ï¸</button>
          <button id="rightBtn">â¡ï¸</button>
          <button id="resetMinigame" style="background:#167;min-width:120px">ğŸ”„ Reiniciar (guardar puntos)</button>
          <button id="pauseBtn" style="background:#555">â¹ï¸ Pausar</button>
        </div>

        <div style="margin-top:8px" class="small">Al reiniciar se transfieren los puntos recogidos a CarriCoins (si estÃ¡s logueado).</div>
      </div>

      <!-- Marketplace -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0">Marketplace</h3>
        <div style="display:flex;gap:8px;margin-top:6px">
          <select id="sellSelect"></select>
          <input id="sellPrice" placeholder="Precio CC" style="width:120px"/>
          <button id="btnSell">Poner a la venta</button>
        </div>

        <h4 style="margin-top:10px">A la venta</h4>
        <div id="marketList" style="max-height:180px;overflow:auto"></div>
      </div>

      <!-- Inventario y Historial -->
      <div class="card" style="margin-top:12px;display:flex;gap:12px">
        <div style="flex:1">
          <h4 style="margin:4px 0">Inventario</h4>
          <div id="invList" style="max-height:180px;overflow:auto"></div>
        </div>
        <div style="width:260px">
          <h4 style="margin:4px 0">Historial de ventas</h4>
          <div id="histList" style="max-height:180px;overflow:auto"></div>
        </div>
      </div>

      <!-- Ruleta y regalos -->
      <div class="card" style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <h4 style="margin:4px 0">Ruleta</h4>
          <div class="small">Tickets: <span id="ticketCount">0</span></div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button id="buy1">Comprar 1 (100 CC)</button>
            <button id="buy10">Comprar 10 (900 CC)</button>
            <button id="spin">Usar ticket</button>
          </div>

          <h4 style="margin-top:12px;margin-bottom:6px">Regalo</h4>
          <div class="small">Toca 500 veces el regalo y obtÃ©n un objeto aleatorio</div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <button id="giftBtn">ğŸ Tocar</button>
            <div class="small" id="giftCount">0 / 500</div>
          </div>
        </div>

        <div style="width:220px">
          <h4 style="margin:4px 0">Lista de objetos (preview)</h4>
          <div id="objPreview" style="max-height:220px;overflow:auto"></div>
        </div>
      </div>

    </div>

    <!-- SIDE: chat, jugadores y objetos por rareza -->
    <div>
      <div class="card">
        <h4 style="margin:4px 0">Chat global</h4>
        <div id="chatMensajes"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="chatInput" placeholder="Escribe..." />
          <button id="sendChat">Enviar</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:4px 0">Jugadores activos</h4>
        <div id="playersList" style="max-height:160px;overflow:auto"></div>
        <div style="margin-top:8px" class="small">Top por CarriCoins</div>
        <div id="topList" style="margin-top:6px;max-height:120px;overflow:auto"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:4px 0">Objetos por rareza</h4>
        <div id="objectsByRarity" style="max-height:280px;overflow:auto"></div>
      </div>
    </div>
  </div>

</div>

<footer>Hecho para ti â€” copia el archivo completo a GitHub Pages o abre localmente</footer>

<!-- ------------------ SCRIPTS: FIREBASE compat + LÃ“GICA ------------------ -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

<script>
/* ====================== CONFIGURA ESTO: pega tu firebaseConfig aquÃ­ ======================
   Reemplaza los valores por tu proyecto (puedes usar el que ya tienes).
   Si vas a compartir el HTML pÃºblico, el config no es secreto (solo claves pÃºblicas).
===========================================================================================*/
const firebaseConfig = {
  apiKey: "AIzaSyADVjuoLhcH34XPmZv-sx-eP71rIxVEKEY",
  authDomain: "juego-marketplace.firebaseapp.com",
  databaseURL: "https://juego-marketplace-default-rtdb.firebaseio.com/",
  projectId: "juego-marketplace",
  storageBucket: "juego-marketplace.firebasestorage.app",
  messagingSenderId: "258620166110",
  appId: "1:258620166110:web:3a101d6f7743b6dbc6574f",
  measurementId: "G-0GZDE8FNEC"
};

firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();
const refUsers = rdb.ref('usuarios');
const refChat = rdb.ref('chat');
const refVentas = rdb.ref('ventas');

/* ====================== OBJETOS Y REGLAS ====================== */
/* Objetos por rareza: Tenta/Xero/Gama/Tux = 5 cada uno; resto 7 cada uno */
const objetosPorRango = {
  "ComÃºn": ["ğŸ¦§ Gorillaz-rondomol","ğŸ¸ PepeSaltarin","ğŸ” PolloNoob","ğŸ¢ TortuSpeed","ğŸ SnekGamer","ğŸ RatÃ³nFail","ğŸ™ PulpoBrainrot"],
  "Raro": ["ğŸ² DragÃ³nThug","ğŸ¦ MonoBruh","ğŸ¦– T-RexEpicFail","ğŸ¦ LeÃ³nMood","ğŸ¦Š ZorroCringe","ğŸ§ PenguinoXD","ğŸµ MonoChad"],
  "Ã‰pico": ["ğŸ™ PulpoOver9000","ğŸ¦„ UnicÃ³rnitoLOL","ğŸº LoboSus","ğŸ‰ DragÃ³nYeet","ğŸ¦Œ RenoBruhMoment","ğŸ´ CaballoCringe","ğŸ¦€ CrabbyMad"],
  "Legendario": ["ğŸ‘‘ ReyCarritoSus","ğŸ‰ DragonCarroYeet","ğŸ¦„ UnicÃ³rnitoBruh","ğŸ¦– T-RexChad","ğŸ² DragÃ³nEpicFail","ğŸ‰ FÃ©nixLOL","ğŸ‰ HydraSus"],
  "UltraLegendario": ["ğŸ² DragÃ³nFinalYeet","ğŸ‰ FÃ©nixCarroLOL","ğŸ‰ HydraUltraBruh","ğŸ‘‘ CarritoSupremoEpic","ğŸ¦„ UnicÃ³rnitoOP","ğŸ›¡ UltraGuard","ğŸ”¥ FlameLord"],
  "OP": ["âš¡ OP-GigaCarro","ğŸ’¥ OP-Smash","ğŸ”¥ OP-Destructor","âš”ï¸ OP-Breaker","ğŸŒª OP-Storm","ğŸ”± OP-Titan","ğŸ›¡ OP-Guardian"],
  "Dioses": ["ğŸ‘¹ MemeDios","ğŸ‘‘ CarroDios","ğŸŒŸ SupremoCarro","âš¡ UltraMeme","ğŸ”¥ DivinoCarrito","ğŸŒ€ CaosDios","â˜¯ï¸ EquilibrioDios"],
  "Gama": ["Gama-A","Gama-B","Gama-C","Gama-D","Gama-E"],
  "Tenta": ["Tenta-A","Tenta-B","Tenta-C","Tenta-D","Tenta-E"],
  "Xero": ["Xero-A","Xero-B","Xero-C","Xero-D","Xero-E"],
  "Tux": ["Tux-A","Tux-B","Tux-C","Tux-D","Tux-E"]
};

/* Mutaciones y probabilidades (en %). "" = sin mutaciÃ³n */
const mutaciones = [
  {code:"", prob:80},
  {code:"CH", prob:8},
  {code:"GH", prob:6},
  {code:"TH", prob:3},
  {code:"RH", prob:2},
  {code:"HH", prob:1}
];

/* Probabilidad por rango (approx; suma 100) */
const rangosProb = [
  {rango:"ComÃºn", prob:30},
  {rango:"Raro", prob:20},
  {rango:"Ã‰pico", prob:15},
  {rango:"Legendario", prob:10},
  {rango:"UltraLegendario", prob:6},
  {rango:"OP", prob:4},
  {rango:"Dioses", prob:2},
  {rango:"Gama", prob:4},
  {rango:"Tenta", prob:4},
  {rango:"Xero", prob:3},
  {rango:"Tux", prob:2}
];

/* ====================== UTILIDADES ====================== */
function elegirPorProb(lista){
  const r = Math.random()*100; let s=0;
  for(let i=0;i<lista.length;i++){ s+=lista[i].prob; if(r<=s) return lista[i]; }
  return lista[0];
}

function obtenerObjetoAleatorio(){
  const rango = elegirPorProb(rangosProb).rango;
  const pool = objetosPorRango[rango] || objetosPorRango["ComÃºn"];
  const base = pool[Math.floor(Math.random()*pool.length)];
  // mutacion
  const mut = elegirPorProb(mutaciones).code;
  const name = mut ? `${base} (${mut})` : base;
  return { nombre: name, rango: rango };
}

/* ====================== ESTADO CLIENTE ====================== */
let me = null; // {user, coins, tickets, objetos:[], historial:[]}
let ventasCache = {}; // ventas actuales
let chatCache = [];

/* ====================== UI HELPERS ====================== */
const $ = id => document.getElementById(id);
function showMe(){ $('meUser').innerText = me ? me.user : 'â€”'; $('meCoins').innerText = me ? (me.coins||0) : 0; $('meTickets').innerText = me ? (me.tickets||0) : 0; $('ticketCount').innerText = me ? (me.tickets||0) : 0; }

/* render inventario */
function renderInventario(){
  const inv = $('invList'); inv.innerHTML = '';
  if(!me || !me.objetos || me.objetos.length===0){ inv.innerHTML = '<div class="small">Inventario vacÃ­o</div>'; return; }
  me.objetos.forEach((it, idx)=>{
    const d = document.createElement('div'); d.className='obj';
    const left = document.createElement('div'); left.innerHTML = `<strong>${it.nombre}</strong><div class="small">${it.rango}</div>`;
    const right = document.createElement('div');
    const sellBtn = document.createElement('button'); sellBtn.textContent='Vender'; sellBtn.onclick = ()=> openSellModal(idx);
    right.appendChild(sellBtn);
    d.appendChild(left); d.appendChild(right);
    inv.appendChild(d);
  });
  // fill sell select options
  const sel = $('sellSelect'); sel.innerHTML = '';
  if(me && me.objetos) me.objetos.forEach((o,i)=>{ const opt = document.createElement('option'); opt.value=i; opt.text = `${o.nombre} (${o.rango})`; sel.appendChild(opt); });
}

/* render ventas */
function renderVentas(){
  const list = $('marketList'); list.innerHTML = '';
  Object.keys(ventasCache).forEach(k=>{
    const v = ventasCache[k];
    const d = document.createElement('div'); d.className='obj';
    d.innerHTML = `<div><strong>${v.nombre}</strong> <div class="small">${v.rango}</div></div>`;
    const right = document.createElement('div');
    right.innerHTML = `<div class="small">${v.precio} CC</div>`;
    const btn = document.createElement('button');
    btn.textContent = (me && me.user === v.vendedor) ? 'Tu venta' : 'Comprar';
    btn.disabled = (me && me.user === v.vendedor);
    btn.onclick = ()=> comprarVenta(k);
    right.appendChild(btn);
    d.appendChild(right);
    list.appendChild(d);
  });
}

/* render chat */
function renderChat(){
  const c = $('chatMensajes'); c.innerHTML='';
  chatCache.forEach(m=>{
    const d = document.createElement('div'); d.innerHTML = `<small style="color:#666">${new Date(m.ts).toLocaleTimeString()}</small> <strong>${m.usuario}</strong>: ${m.texto}`;
    c.appendChild(d);
  });
  c.scrollTop = c.scrollHeight;
}

/* render players + top */
function renderPlayersList(usersObj){
  const players = $('playersList'); players.innerHTML='';
  const arr = Object.keys(usersObj||{}).map(u=>({user:u, coins: usersObj[u].coins||0, lastSeen:usersObj[u].lastSeen||0}));
  arr.sort((a,b)=>b.lastSeen-a.lastSeen);
  $('activeCount').innerText = arr.length;
  arr.forEach(p=>{
    const d = document.createElement('div'); d.className='small'; d.innerText = `${p.user} â€¢ ${p.coins} CC`;
    players.appendChild(d);
  });
  // top
  const top = $('topList'); top.innerHTML='';
  arr.sort((a,b)=>b.coins-a.coins).slice(0,10).forEach(t=>{
    const d = document.createElement('div'); d.className='small'; d.innerText = `${t.user}: ${t.coins} CC`;
    top.appendChild(d);
  });
}

/* render objects by rarity preview */
function renderObjectsByRarity(){
  const cont = $('objectsByRarity'); cont.innerHTML='';
  Object.keys(objetosPorRango).forEach(r=>{
    const group = objetosPorRango[r];
    group.forEach(name=>{
      const d = document.createElement('div'); d.className='obj'; d.innerHTML = `<div>${name}<div class="small">${r}</div></div><div><span class="badge rare-${r}">${r}</span></div>`;
      cont.appendChild(d);
    });
  });
}

/* render preview small list for side */
function renderPreview(){
  const p = $('objPreview'); p.innerHTML='';
  const sample = [];
  Object.keys(objetosPorRango).forEach(r=>{
    objetosPorRango[r].slice(0,3).forEach(n=> sample.push({n,r}));
  });
  sample.slice(0,12).forEach(s=>{
    const d = document.createElement('div'); d.className='small'; d.innerText = `${s.n} (${s.r})`; p.appendChild(d);
  });
}

/* ====================== AUTH / USERS ====================== */
function createAccount(user, pass){
  if(!user || !pass) return alert('Usuario y contraseÃ±a requeridos');
  refUsers.child(user).get().then(snap=>{
    if(snap.exists()) return alert('Usuario ya existe');
    // crear 3 comunes
    const comunes = objetosPorRango['ComÃºn'];
    const objs = [];
    for(let i=0;i<3;i++){ objs.push({nombre: comunes[Math.floor(Math.random()*comunes.length)], rango:'ComÃºn'}); }
    const payload = { pass: pass, coins:50, tickets:0, objetos: objs, historial: [], lastSeen: Date.now() };
    refUsers.child(user).set(payload).then(()=>{ alert('Cuenta creada: 3 objetos comunes y 50 CC'); });
  });
}

function login(user, pass){
  if(!user || !pass) return alert('Usuario y contraseÃ±a requeridos');
  refUsers.child(user).get().then(snap=>{
    if(!snap.exists()) return alert('Usuario no encontrado');
    const val = snap.val();
    if(val.pass !== pass) return alert('ContraseÃ±a incorrecta');
    // login success
    me = { user: user, coins: val.coins||0, tickets: val.tickets||0, objetos: val.objetos||[], historial: val.historial||[] };
    localStorage.setItem('mj_user', user);
    // update lastSeen
    refUsers.child(user).update({ lastSeen: Date.now() });
    postLoginUI();
  });
}

function postLoginUI(){
  $('btnLogin').style.display='none';
  $('btnCreate').style.display='none';
  $('btnLogout').style.display='inline-block';
  $('meUser').innerText = me.user;
  showMe();
  renderInventario();
  renderVentas(); renderPreview();
}

/* logout */
function logout(){
  me = null;
  localStorage.removeItem('mj_user');
  $('btnLogin').style.display='inline-block';
  $('btnCreate').style.display='inline-block';
  $('btnLogout').style.display='none';
  $('meUser').innerText='â€”'; $('meCoins').innerText='0';
}

/* ====================== MARKET ACTIONS ====================== */
function openSellModal(index){
  const price = prompt('Precio en CarriCoins para vender este objeto:');
  const p = parseInt(price);
  if(isNaN(p) || p<=0) return alert('Precio invÃ¡lido');
  // poner en venta firebase: remove obj from user -> push venta
  refUsers.child(me.user).child('objetos').get().then(snap=>{
    const arr = snap.exists() ? snap.val() : [];
    if(!arr[index]) return alert('Objeto no encontrado');
    const obj = arr.splice(index,1)[0];
    refUsers.child(me.user).update({ objetos: arr }).then(()=>{
      const venta = { vendedor: me.user, nombre: obj.nombre, rango: obj.rango, precio: p, ts: Date.now() };
      const newKey = refVentas.push(venta).key;
      // venta ya publicada; firebase listener actualizarÃ¡ UI
    });
  });
}

function sellSelected(){
  const idx = parseInt($('sellSelect').value);
  const pr = parseInt($('sellPrice').value);
  if(isNaN(pr) || pr<=0) return alert('Precio invÃ¡lido');
  openSellModal(idx); // reuse prompt flow
}
window.sellSelected = sellSelected;

/* comprar venta by key */
function comprarVenta(key){
  if(!me) return alert('Inicia sesiÃ³n para comprar');
  refVentas.child(key).get().then(snap=>{
    if(!snap.exists()) return alert('Venta no existe');
    const v = snap.val();
    if(v.vendedor === me.user) return alert('No puedes comprar tu propia venta');
    // verify coins
    if((me.coins||0) < v.precio) return alert('No tienes CarriCoins');
    // deduct buyer
    const newBuyerCoins = (me.coins||0) - v.precio;
    refUsers.child(me.user).update({ coins: newBuyerCoins }).then(()=>{
      // add object to buyer
      refUsers.child(me.user).child('objetos').get().then(buySnap=>{
        const buyerObjs = buySnap.exists() ? buySnap.val() : [];
        buyerObjs.push({ nombre: v.nombre, rango: v.rango });
        refUsers.child(me.user).update({ objetos: buyerObjs });
        // pay seller
        refUsers.child(v.vendedor).get().then(snapV=>{
          const seller = snapV.val() || {};
          const newSellerCoins = (seller.coins||0) + v.precio;
          const sellerHist = seller.historial || [];
          sellerHist.push({ vendido: v.nombre, precio: v.precio, cuando: Date.now() });
          refUsers.child(v.vendedor).update({ coins: newSellerCoins, historial: sellerHist }).then(()=>{
            // remove venta
            refVentas.child(key).remove();
          }); 
        });
      });
    });
  });
}

/* ====================== TICKETS & RULETA ====================== */
function comprarTickets(cant){
  if(!me) return alert('Inicia sesiÃ³n');
  const precio = cant === 1 ? 100 : 900;
  if((me.coins||0) < precio) return alert('No tienes CC');
  const newCoins = (me.coins||0) - precio;
  const newTickets = (me.tickets||0) + cant;
  refUsers.child(me.user).update({ coins: newCoins, tickets: newTickets });
}

function usarTicket(){
  if(!me) return alert('Inicia sesiÃ³n');
  if((me.tickets||0) < 1) return alert('No tienes tickets');
  refUsers.child(me.user).get().then(snap=>{
    const data = snap.val() || {};
    const tickets = (data.tickets||0) - 1;
    refUsers.child(me.user).update({ tickets: tickets }).then(()=>{
      const obj = obtenerObjetoAleatorio();
      // add to user
      refUsers.child(me.user).child('objetos').get().then(os=>{
        const arr = os.exists() ? os.val() : [];
        arr.push(obj);
        refUsers.child(me.user).update({ objetos: arr }).then(()=> alert('Ganaste: ' + obj.nombre));
      });
    });
  });
}

/* ====================== REGALO 500 TOQUES ====================== */
let giftCount = 0;
$('giftBtn')?.addEventListener?.('click', ()=>{ giftCount++; $('giftCount').innerText = `${giftCount} / 500`; if(giftCount>=500){ if(!me) return alert('Inicia sesiÃ³n'); const obj = obtenerObjetoAleatorio(); refUsers.child(me.user).child('objetos').get().then(snap=>{ const arr = snap.exists()?snap.val():[]; arr.push(obj); refUsers.child(me.user).update({ objetos: arr }).then(()=> alert('Recibiste: '+obj.nombre)); }); giftCount=0; $('giftCount').innerText='0 / 500'; } });

/* ====================== CHAT Realtime ====================== */
$('sendChat').addEventListener('click', ()=> {
  const txt = $('chatInput').value.trim();
  if(!txt) return;
  if(!me) return alert('Inicia sesiÃ³n para chatear');
  refChat.push({ usuario: me.user, texto: txt, ts: Date.now() });
  $('chatInput').value='';
});
/* reset chat cada 3 minutos en servidor: aquÃ­ cliente tambiÃ©n pide borrarlo cada 3m */
setInterval(()=>{ refChat.remove(); }, 180000);

/* ====================== MINIJUEGO: cubos ====================== */
let score = 0;
let cubos = [];
let gameInterval = null;
let paused = false;
function startMinigame(){
  if(gameInterval) clearInterval(gameInterval);
  gameInterval = setInterval(()=>{
    // spawn cube sometimes
    if(Math.random()<0.06){
      const c = document.createElement('div'); c.className='cubo'; c.style.left = (Math.random()*80)+'%'; c.style.top='-10%';
      $('juegoArea').appendChild(c);
      cubos.push(c);
      // remove after time
      setTimeout(()=>{ if(c.parentNode) c.parentNode.removeChild(c); cubos = cubos.filter(x=>x!==c); }, 3000);
    }
    // move cubes down
    cubos.forEach((c,i)=>{
      const top = parseFloat(c.style.top) || -10;
      c.style.top = (top + 0.9) + '%';
      // collision
      const pL = parseFloat($('player').style.left)||45, pR = pL + 10;
      const cL = parseFloat(c.style.left)||0, cR = cL + 10;
      const pT = 80, pB = 95; // approximate
      const cT = parseFloat(c.style.top), cB = cT + 12;
      if(!(pR < cL || pL > cR || pB < cT || pT > cB)){
        // collision: end round
        if(me) refUsers.child(me.user).get().then(snap=>{ const cur = snap.val()||{}; const newCoins = (cur.coins||0) + score; refUsers.child(me.user).update({ coins: newCoins }); });
        alert('Te chocaste! Ganaste ' + score + ' CC (transferidos)');
        score = 0; $('scoreVal').innerText = score;
        cubos.forEach(cc=>cc.remove()); cubos=[]; clearInterval(gameInterval); gameInterval = null;
      }
    });
  }, 40);
}
$('leftBtn').addEventListener('click', ()=>{ const cur = parseFloat($('player').style.left)||45; $('player').style.left = Math.max(0,cur-10)+'%'; });
$('rightBtn').addEventListener('click', ()=>{ const cur = parseFloat($('player').style.left)||45; $('player').style.left = Math.min(80,cur+10)+'%'; });
$('resetMinigame').addEventListener('click', ()=>{
  if(me) refUsers.child(me.user).get().then(snap=>{ const d = snap.val()||{}; const newCoins = (d.coins||0) + score; refUsers.child(me.user).update({ coins: newCoins }); });
  score = 0; $('scoreVal').innerText = 0;
  cubos.forEach(c=>c.remove()); cubos=[]; if(gameInterval){ clearInterval(gameInterval); gameInterval = null; } startMinigame();
});
$('pauseBtn').addEventListener('click', ()=>{
  if(paused){ paused=false; $('pauseBtn').innerText='â¹ï¸ Pausar'; startMinigame(); } else { paused=true; $('pauseBtn').innerText='â–¶ï¸ Reanudar'; if(gameInterval) { clearInterval(gameInterval); gameInterval = null; } }
});

/* increase points as cubes pass bottom (approx) */
setInterval(()=>{ // simulate awarding points when cube passes bottom
  // count removed cubes -> award points
  // simple approach: random chance to increment score
  if(gameInterval && Math.random()<0.12){ score++; $('scoreVal').innerText = score; }
}, 600);

/* ====================== LISTENERS Y LISTENERS FIREBASE ====================== */
$('btnCreate').addEventListener('click', ()=> createAccount($('inputUser').value.trim(), $('inputPass').value.trim()));
$('btnLogin').addEventListener('click', ()=> login($('inputUser').value.trim(), $('inputPass').value.trim()));
$('btnLogout').addEventListener('click', ()=> logout());
$('btnSell').addEventListener('click', ()=> sellSelected());
$('buy1').addEventListener('click', ()=> comprarTickets(1));
$('buy10').addEventListener('click', ()=> comprarTickets(10));
$('spin').addEventListener('click', ()=> usarTicket());
$('sendChat').addEventListener('click', ()=> $('sendChat').click()); // noop in case button not available

/* Firebase realtime listeners */
refChat.on('value', snap=>{
  const val = snap.val() || {};
  const arr = Object.keys(val).map(k=>val[k]).sort((a,b)=>a.ts - b.ts);
  chatCache = arr;
  renderChat();
});

refVentas.on('value', snap=>{
  const val = snap.val() || {};
  ventasCache = val;
  renderVentas();
});

/* users listener for active players and my data updates */
refUsers.on('value', snap=>{
  const val = snap.val() || {};
  renderPlayersList(val);
  // if logged in, refresh my data from DB to stay synced
  const logged = localStorage.getItem('mj_user');
  if(logged){
    refUsers.child(logged).get().then(s=>{
      const data = s.val();
      if(data){
        me = { user: logged, coins: data.coins||0, tickets: data.tickets||0, objetos: data.objetos||[], historial: data.historial||[] };
        showMe(); renderInventario();
      }
    });
  }
});

/* comprarVenta wrapper for global use (button sets) */
/* We exposed comprarVenta to window earlier implicitly when creating buttons by referencing the function name string. To ensure it's available globally: */
window.comprarVenta = comprarVenta;

/* expose helper sellSelected globally */
window.openSellModal = openSellModal;
function sellSelected(){
  const idx = $('sellSelect').value;
  const price = parseInt($('sellPrice').value);
  if(isNaN(price) || price<=0) return alert('Precio invÃ¡lido');
  openSellModal(parseInt(idx));
}
window.sellSelected = sellSelected;

/* ====================== INICIALIZACIÃ“N UI ====================== */
renderPreview();
renderObjectsByRarity();
startMinigame(); // inicia minijuego en background

/* restaurar sesiÃ³n guardada */
const saved = localStorage.getItem('mj_user');
if(saved){
  // try to restore me object from firebase
  refUsers.child(saved).get().then(snap=>{
    if(snap.exists()){
      const d = snap.val();
      me = { user: saved, coins: d.coins||0, tickets: d.tickets||0, objetos: d.objetos||[], historial: d.historial||[] };
      localStorage.setItem('mj_user', saved);
      postLoginUI();
    }
  });
}
</script>

</body>
</html>
```î¨0î¨‚
