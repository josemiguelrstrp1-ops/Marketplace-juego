<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marketplace Meme Colombiano (Realtime)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f2f2f2;margin:0;padding:0;color:#111;text-align:center}
  .pantalla{display:none;padding:16px}
  button{padding:8px 10px;margin:6px;font-size:15px;cursor:pointer}
  #topCoins{font-size:20px;display:none;margin:10px 0}
  #juegoArea{width:90vw;max-width:420px;height:52vh;background:#222;margin:10px auto;position:relative;overflow:hidden;border-radius:8px}
  #player{width:10%;min-width:30px;height:10%;min-height:30px;background:#0f0;position:absolute;bottom:6%;left:45%}
  .cubo{width:10%;min-width:30px;height:10%;min-height:30px;background:red;position:absolute;top:0}
  #chatMensajes{height:220px;overflow:auto;border:1px solid #000;background:#fff;padding:6px;text-align:left;margin:8px 0}
  #invLista div,#objLista div,#histLista div,#listaVentas div,#chatMensajes div{margin:6px;padding:6px;border:1px solid #000;background:#fff}
  .botonesMovimiento button{width:30vw;max-width:140px;height:44px;font-size:20px;margin:6px}
  input,select{font-size:15px;padding:6px;margin:6px}
  .row{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
</style>
</head>
<body>

<h2 id="topCoins">CarriCoins: 0</h2>

<!-- LOGIN -->
<div id="login" class="pantalla" style="display:block">
  <h1>Iniciar sesiÃ³n / Crear cuenta</h1>
  <input id="user" placeholder="Usuario" autocomplete="off"><br>
  <input id="pass" placeholder="ContraseÃ±a" type="password"><br>
  <button onclick="crearCuenta()">Crear cuenta (3 objetos comunes)</button>
  <button onclick="entrar()">Entrar</button>
</div>

<!-- MENU -->
<div id="menu" class="pantalla">
  <h1>MenÃº Principal</h1>
  <div class="row">
    <button onclick="mostrar('juego')">Jugar: esquivar cubos</button>
    <button onclick="mostrar('market')">Marketplace</button>
  </div>
  <div class="row">
    <button onclick="mostrar('inventario')">Inventario</button>
    <button onclick="mostrar('historial')">Historial ventas</button>
  </div>
  <div class="row">
    <button onclick="mostrar('objLista')">Lista de objetos</button>
    <button onclick="mostrar('regalo')">Regalo (500 toques)</button>
  </div>
  <div class="row">
    <button onclick="mostrar('ruleta')">Ruleta</button>
    <button onclick="mostrar('chatPantalla')">Chat / Jugadores</button>
  </div>
</div>

<!-- JUEGO -->
<div id="juego" class="pantalla">
  <h2>Esquivar cubos</h2>
  <div id="juegoArea"><div id="player"></div></div>
  <p id="score">Puntos: 0</p>
  <div class="botonesMovimiento">
    <button onclick="mover(-10)">â¬…ï¸</button>
    <button onclick="mover(10)">â¡ï¸</button>
    <button id="pauseBtn">â¹ï¸ Pausar/Reanudar</button>
  </div>
  <div class="row">
    <button onclick="reiniciarCubos()">ğŸ”„ Reiniciar (guardar puntos)</button>
    <button onclick="volverMenu()">Volver</button>
  </div>
</div>

<!-- MARKET -->
<div id="market" class="pantalla">
  <h2>Marketplace</h2>
  <h3>Vender</h3>
  <select id="sellItem"></select><br>
  <input id="sellPrice" placeholder="Precio en CarriCoins (nÃºmero)"><br>
  <button onclick="ponerEnVenta()">Poner en venta</button>
  <h3>Comprar (listado global)</h3>
  <div id="listaVentas"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- INVENTARIO -->
<div id="inventario" class="pantalla">
  <h2>Inventario</h2>
  <div id="invLista"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- HISTORIAL -->
<div id="historial" class="pantalla">
  <h2>Historial de ventas</h2>
  <div id="histLista"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- OBJETOS -->
<div id="objLista" class="pantalla">
  <h2>Objetos por rareza</h2>
  <div id="listaObjetos"></div>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- REGALO -->
<div id="regalo" class="pantalla">
  <h2>Regalo</h2>
  <p>Toca 500 veces para recibir un objeto</p>
  <p id="toques">Toques: 0 / 500</p>
  <button id="tocarRegalo">ğŸ</button>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- RULETA -->
<div id="ruleta" class="pantalla">
  <h2>Ruleta de Objetos</h2>
  <p>Tickets disponibles: <span id="ticketCount">0</span></p>
  <button onclick="comprarTicket(1)">Comprar 1 Ticket (100 CC)</button>
  <button onclick="comprarTicket(10)">Paquete 10 Tickets (900 CC)</button><br>
  <button onclick="usarTicket()">Usar Ticket en Ruleta</button><br>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
</div>

<!-- CHAT Y JUGADORES -->
<div id="chatPantalla" class="pantalla">
  <h2>Chat Global</h2>
  <div id="chatMensajes"></div>
  <input id="chatInput" placeholder="Escribe tu mensaje" style="width:70%">
  <button onclick="enviarMensaje()">Enviar</button>
  <div class="row"><button onclick="volverMenu()">Volver</button></div>
  <h3>Jugadores activos</h3>
  <div id="jugadoresActivos"></div>
  <h3>Top CarriCoins</h3>
  <div id="topDinero"></div>
</div>

<!-- ================= SCRIPT PRINCIPAL (LÃ“GICA + OBJETOS + PLACEHOLDERS) ================= -->
<script>
/* Local cache (se usa como respaldo, la versiÃ³n real es en Firebase). */
let cache = {}; // local cache
let userActual = null;
let puntos = 0;
let cubosActivos = [];
let intervalo = null;
let juegoPausado = false;
let toques = 0;
let ventasLocal = [];
let player = document.getElementById('player');
let chatMensajes = [];

/* ---- LISTA DE OBJETOS SEGÃšN TU REGLA ----
   - Tenta, Xero, Gama, Tux: 5 items cada uno
   - Resto (ComÃºn .. Dioses): 7 items cada uno
*/
const objetosPorRango = {
  "ComÃºn": [
    "ğŸ¦§ Goriloco-BananÃ­n","ğŸ¸ PepeSaltarin","ğŸ” PolloNoob","ğŸ¢ TortuSpeed","ğŸ SnekGamer","ğŸ RatÃ³nFail","ğŸ™ PulpoBrainrot"
  ],
  "Raro": [
    "ğŸ² DragÃ³nThug","ğŸ¦ MonoBruh","ğŸ¦– T-RexEpicFail","ğŸ¦ LeÃ³nMood","ğŸ¦Š ZorroCringe","ğŸ§ PenguinoXD","ğŸµ MonoChad"
  ],
  "Ã‰pico": [
    "ğŸ™ PulpoOver9000","ğŸ¦„ UnicÃ³rnitoLOL","ğŸº LoboSus","ğŸ‰ DragÃ³nYeet","ğŸ¦Œ RenoBruhMoment","ğŸ´ CaballoCringe","ğŸ¦€ CrabbyMad"
  ],
  "Legendario": [
    "ğŸ‘‘ ReyCarritoSus","ğŸ‰ DragonCarroYeet","ğŸ¦„ UnicÃ³rnitoBruh","ğŸ¦– T-RexChad","ğŸ² DragÃ³nEpicFail","ğŸ‰ FÃ©nixLOL","ğŸ‰ HydraSus"
  ],
  "UltraLegendario": [
    "ğŸ² DragÃ³nFinalYeet","ğŸ‰ FÃ©nixCarroLOL","ğŸ‰ HydraUltraBruh","ğŸ‘‘ CarritoSupremoEpic","ğŸ¦„ UnicÃ³rnitoOP","ğŸ‰ NovaSus","ğŸ‰ AstroDios"
  ],
  "OP": [
    "âš¡ OP-GigaCarro","ğŸ’¥ OP-Smash","ğŸ”¥ OP-Destructor","âš”ï¸ OP-Breaker","ğŸŒª OP-Storm","ğŸ”± OP-Titan","ğŸ›¡ OP-Guardian"
  ],
  "Dioses": [
    "ğŸ‘¹ MemeDios","ğŸ‘‘ CarroDios","ğŸŒŸ SupremoCarro","âš¡ UltraMeme","ğŸ”¥ DivinoCarrito","ğŸŒ€ CaosDios","â˜¯ï¸ EquilibrioDios"
  ],
  // raras especiales: solo 5 cada una
  "Gama": ["Gama-1","Gama-2","Gama-3","Gama-4","Gama-5"],
  "Tenta": ["Tenta-1","Tenta-2","Tenta-3","Tenta-4","Tenta-5"],
  "Xero": ["Xero-1","Xero-2","Xero-3","Xero-4","Xero-5"],
  "Tux": ["Tux-1","Tux-2","Tux-3","Tux-4","Tux-5"]
};

/* Mutaciones y probabilidades (mutaciones raras)
   "" = sin mutaciÃ³n (comÃºn)
   CH GH TH RH HH = muy raras
*/
const mutaciones = [
  {code:"", prob:85},
  {code:"CH", prob:7},
  {code:"GH", prob:4},
  {code:"TH", prob:2},
  {code:"RH", prob:1.5},
  {code:"HH", prob:0.5}
];

/* Raridades y probabilidades base (ajusta si quieres) */
const rangosProb = [
  {rango:"ComÃºn", prob:30},
  {rango:"Raro", prob:20},
  {rango:"Ã‰pico", prob:15},
  {rango:"Legendario", prob:10},
  {rango:"UltraLegendario", prob:7},
  {rango:"OP", prob:6},
  {rango:"Dioses", prob:4},
  {rango:"Gama", prob:3},
  {rango:"Tenta", prob:2},
  {rango:"Xero", prob:2},
  {rango:"Tux", prob:1}
];

/* Escoge rango segÃºn prob */
function seleccionarRango(){
  const r = Math.random()*100;
  let acum=0;
  for(let i=0;i<rangosProb.length;i++){
    acum += rangosProb[i].prob;
    if(r<=acum) return rangosProb[i].rango;
  }
  return "ComÃºn";
}

/* Escoge mutaciÃ³n con probabilidades */
function seleccionarMutacion(){
  const r = Math.random()*100;
  let acum=0;
  for(let i=0;i<mutaciones.length;i++){
    acum += mutaciones[i].prob;
    if(r<=acum) return mutaciones[i].code;
  }
  return "";
}

/* Obtener objeto aleatorio teniendo en cuenta mutaciones (mut reduce prob de aparecer ya por el prob set) */
function obtenerObjetoAleatorio(){
  const rango = seleccionarRango();
  const lista = objetosPorRango[rango] || objetosPorRango["ComÃºn"];
  const nombreBase = lista[Math.floor(Math.random()*lista.length)];
  const mut = seleccionarMutacion();
  const nombreFinal = mut ? `${nombreBase} (${mut})` : nombreBase;
  return { nombre: nombreFinal, rango: rango };
}

/* ===== UI helpers (misma estructura que antes) ===== */
function guardarLocal(){
  localStorage.setItem("cache", JSON.stringify(cache));
  if(userActual) localStorage.setItem("userActual", userActual);
}
function mostrar(id){
  document.querySelectorAll('.pantalla').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
  if(id==="objLista") mostrarListaObjetos();
  actualizarJugadoresUI(); // actualizar lista visible
}
function volverMenu(){mostrar('menu');}
function actualizarTopCoinsUI(coins){ document.getElementById('topCoins').innerText="CarriCoins: "+coins; document.getElementById('topCoins').style.display='block'; }

/* ====== Juego: mover, iniciar cubos, reiniciar ====== */
function mover(x){ let pos = parseFloat(player.style.left)||45; pos+=x; if(pos<0) pos=0; if(pos>80) pos=80; player.style.left=pos+"%"; }
function limpiarCubos(){ cubosActivos.forEach(c=>c.remove()); cubosActivos=[]; clearInterval(intervalo); }
function reiniciarCubos(){ 
  if(userActual) sumarCoinsFirebase(puntos);
  puntos=0; document.getElementById('score').innerText="Puntos: 0"; limpiarCubos(); if(!juegoPausado) iniciarCubos();
}
function iniciarCubos(){
  clearInterval(intervalo);
  intervalo=setInterval(()=>{
    if(Math.random()<0.03){ let cubo=document.createElement('div'); cubo.className='cubo'; cubo.style.left=Math.random()*80+'%'; cubo.style.top='0%'; document.getElementById('juegoArea').appendChild(cubo); cubosActivos.push(cubo); }
    cubosActivos.forEach((c,i)=>{
      let top=parseFloat(c.style.top); c.style.top=(top+0.6)+'%';
      let pL=parseFloat(player.style.left), pR=pL+10, pT=90, pB=100, cL=parseFloat(c.style.left), cR=cL+10, cT=parseFloat(c.style.top), cB=cT+10;
      if(!(pR<cL||pL>cR||pB<cT||pT>cB)){
        if(userActual) sumarCoinsFirebase(puntos);
        alert("Te chocaste! Ganaste "+puntos+" CarriCoins");
        reiniciarCubos();
      }
      if(cT>100){ c.remove(); cubosActivos.splice(i,1); puntos++; document.getElementById('score').innerText="Puntos: "+puntos; }
    });
  },20);
}
document.getElementById('pauseBtn').addEventListener('click', ()=>{
  if(!juegoPausado){ clearInterval(intervalo); juegoPausado=true; alert("Juego pausado â¹ï¸"); }
  else{ iniciarCubos(); juegoPausado=false; alert("Juego reanudado â–¶ï¸"); }
});

/* ====== regalo 500 toques ====== */
document.getElementById('tocarRegalo').addEventListener('click',()=>{
  toques++; document.getElementById('toques').innerText=toques+" / 500";
  if(toques>=500){
    if(!userActual){ alert("Inicia sesiÃ³n para recibir el objeto"); toques=0; document.getElementById('toques').innerText=toques+" / 500"; return; }
    const obj = obtenerObjetoAleatorio();
    agregarObjetoAUsuarioFirebase(obj);
    alert("Â¡Recibiste un objeto del regalo!: "+obj.nombre);
    toques=0; document.getElementById('toques').innerText=toques+" / 500";
  }
});

/* ====== RULETA ====== */
function comprarTicket(cant){ if(!userActual){ alert("Inicia sesiÃ³n"); return; } const precio = cant==1?100:900; comprarTicketsFirebase(cant,precio); }
function usarTicket(){ usarTicketFirebase(); }

/* ====== CHAT UI (se actualiza desde Firebase) ====== */
function mostrarChatUI(arr){ let chatDiv=document.getElementById('chatMensajes'); chatDiv.innerHTML=''; arr.forEach(m=>{ let d=document.createElement('div'); d.innerText = m.usuario + ': ' + m.texto; chatDiv.appendChild(d); }); chatDiv.scrollTop = chatDiv.scrollHeight; }

/* ====== Jugadores y Top UI ====== */
function actualizarJugadoresUI(usuarios){
  let jugadoresDiv=document.getElementById('jugadoresActivos'); jugadoresDiv.innerHTML='';
  let topDiv=document.getElementById('topDinero'); topDiv.innerHTML='';
  if(!usuarios) return;
  let list = Object.keys(usuarios).map(u=>({usuario:u,coins:usuarios[u].coins||0}));
  list.forEach(x=>{ let d=document.createElement('div'); d.innerText = x.usuario; jugadoresDiv.appendChild(d); });
  list.sort((a,b)=>b.coins-a.coins);
  list.slice(0,10).forEach(t=>{ let d=document.createElement('div'); d.innerText = t.usuario + ': ' + t.coins + ' CC'; topDiv.appendChild(d); });
}

/* ====== Mostrar lista objetos (UI) ====== */
function mostrarListaObjetos(){
  const cont=document.getElementById('listaObjetos'); cont.innerHTML='';
  Object.keys(objetosPorRango).forEach(r=>{
    objetosPorRango[r].forEach(n=>{
      let d=document.createElement('div'); d.innerText = n + ' ('+r+')'; cont.appendChild(d);
    });
  });
}

/* =================== FIREBASE (compat) =================== */
/* Usamos compat para mejor compatibilidad en mÃ³viles */
</script>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

<script>
/* CONFIG: reemplaza si quieres, aquÃ­ estÃ¡ tu config actual */
const firebaseConfig = {
  apiKey: "AIzaSyADVjuoLhcH34XPmZv-sx-eP71rIxVEKEY",
  authDomain: "juego-marketplace.firebaseapp.com",
  databaseURL: "https://juego-marketplace-default-rtdb.firebaseio.com/",
  projectId: "juego-marketplace",
  storageBucket: "juego-marketplace.firebasestorage.app",
  messagingSenderId: "258620166110",
  appId: "1:258620166110:web:3a101d6f7743b6dbc6574f",
  measurementId: "G-0GZDE8FNEC"
};

firebase.initializeApp(firebaseConfig);
const rtdb = firebase.database();
const refUsuarios = rtdb.ref('usuarios');
const refChat = rtdb.ref('chat');
const refVentas = rtdb.ref('ventas');

console.log("Firebase compat conectado");

/* ---------- LISTENERS EN TIEMPO REAL ---------- */

// Chat
refChat.on('value', snap=>{
  const obj = snap.val() || {};
  const arr = Object.keys(obj).map(k=>({key:k, usuario: obj[k].usuario, texto: obj[k].texto, ts: obj[k].ts})).sort((a,b)=>a.ts-b.ts);
  chatMensajes = arr;
  mostrarChatUI(arr);
});

// Ventas
refVentas.on('value', snap=>{
  const obj = snap.val() || {};
  const arr = Object.keys(obj).map(k=>({key:k, vendedor: obj[k].vendedor, nombre: obj[k].nombre, precio: obj[k].precio, rango: obj[k].rango}));
  // actualizar UI
  const lista = document.getElementById('listaVentas'); lista.innerHTML='';
  arr.forEach(v=>{
    let d=document.createElement('div');
    const boton = (v.vendedor!==userActual) ? `<button onclick="comprarVentaFirebase('${v.key || v.key}')">Comprar</button>` : "[Tu objeto]";
    d.innerHTML = `${v.nombre} (${v.rango}) - ${v.precio} CC - ${v.vendedor} ${v.key ? '' : ''}`;
    // we attach element and set data-key attribute
    d.dataset.key = v.key || '';
    lista.appendChild(d);
  });
});

// Usuarios -> top y lista
refUsuarios.on('value', snap=>{
  const obj = snap.val() || {};
  actualizarJugadoresUI(obj);
  // si estoy logueado, refrescar mi UI
  if(userActual && obj[userActual]){
    const me = obj[userActual];
    actualizarTopCoinsUI(me.coins || 0);
    // inventario e historial UI
    const items = me.objetos || [];
    const hist = me.historial || [];
    // actualizar inv
    const invDiv = document.getElementById('invLista'); invDiv.innerHTML='';
    items.forEach(it=>{ let el=document.createElement('div'); el.innerText = it.nombre+" ("+it.rango+")"; invDiv.appendChild(el); });
    const hisDiv = document.getElementById('histLista'); hisDiv.innerHTML='';
    hist.forEach(h=>{ let el=document.createElement('div'); el.innerText = `Vendiste ${h.vendido} por ${h.precio} CC`; hisDiv.appendChild(el); });
    document.getElementById('ticketCount').innerText = me.tickets || 0;
  }
});

/* ---------- FUNCIONES FIREBASE ---------- */

function crearCuentaFirebase(user, pass){
  refUsuarios.child(user).get().then(snap=>{
    if(snap.exists()){ alert("Usuario ya existe"); return; }
    // crear 3 comunes
    const comunes = objetosPorRango["ComÃºn"];
    let objs = [];
    for(let i=0;i<3;i++){ const n = comunes[Math.floor(Math.random()*comunes.length)]; objs.push({nombre:n, rango:"ComÃºn"}); }
    const data = { pass: pass, coins: 50, objetos: objs, historial: [], tickets: 0, lastSeen: Date.now() };
    refUsuarios.child(user).set(data).then(()=>{ alert("Cuenta creada con 3 objetos comunes y 50 CC"); });
  });
}

function loginFirebase(user, pass){
  refUsuarios.child(user).get().then(snap=>{
    if(!snap.exists() || snap.val().pass !== pass){ alert("Usuario o contraseÃ±a incorrectos"); return; }
    userActual = user;
    localStorage.setItem('userActual', userActual);
    // carga UI se hace por el listener de refUsuarios
    refUsuarios.child(user).update({ lastSeen: Date.now() });
    mostrar('menu');
  });
}

function sumarCoinsFirebase(amount){
  if(!userActual) return;
  refUsuarios.child(userActual).get().then(snap=>{
    const cur = (snap.exists() && snap.val().coins) ? snap.val().coins : 0;
    refUsuarios.child(userActual).update({ coins: cur + (amount||0) });
  });
}

function ponerEnVentaFirebase(index, precio){
  if(!userActual){ alert("Inicia sesiÃ³n"); return; }
  refUsuarios.child(userActual).get().then(snap=>{
    const data = snap.val();
    if(!data || !data.objetos || !data.objetos[index]){ alert("Objeto invÃ¡lido"); return; }
    const obj = data.objetos[index];
    // remover del inventario local y subir cambios
    data.objetos.splice(index,1);
    refUsuarios.child(userActual).update({ objetos: data.objetos }).then(()=>{
      // push venta
      const venta = { vendedor: userActual, nombre: obj.nombre, precio: precio, rango: obj.rango, ts: Date.now() };
      refVentas.push(venta);
    });
  });
}

function comprarVentaFirebase(key){
  if(!userActual){ alert("Inicia sesiÃ³n"); return; }
  refVentas.child(key).get().then(snap=>{
    if(!snap.exists()){ alert("Venta no existe"); return; }
    const venta = snap.val();
    if(venta.vendedor === userActual){ alert("No puedes comprar tu propio objeto"); return; }
    refUsuarios.child(userActual).get().then(buySnap=>{
      const buyer = buySnap.val();
      if((buyer.coins||0) < venta.precio){ alert("No tienes suficientes CC"); return; }
      // restar al comprador
      const newBuyerCoins = (buyer.coins||0) - venta.precio;
      refUsuarios.child(userActual).update({ coins: newBuyerCoins }).then(()=>{
        // agregar objeto al comprador
        refUsuarios.child(userActual).child('objetos').get().then(objSnap=>{
          const arr = objSnap.exists() ? objSnap.val() : [];
          arr.push({ nombre: venta.nombre, rango: venta.rango });
          refUsuarios.child(userActual).update({ objetos: arr }).then(()=>{
            // dar dinero al vendedor y registrar historial
            refUsuarios.child(venta.vendedor).get().then(vsnap=>{
              const vendData = vsnap.val() || {};
              const vendCoins = (vendData.coins||0) + venta.precio;
              const vendHist = vendData.historial || [];
              vendHist.push({ vendido: venta.nombre, precio: venta.precio, cuando: Date.now() });
              refUsuarios.child(venta.vendedor).update({ coins: vendCoins, historial: vendHist }).then(()=>{
                // eliminar venta
                refVentas.child(key).remove();
              });
            });
          });
        });
      });
    });
  });
}

function obtenerObjetoAleatorioFirebase(){
  // wrapper para compatibilidad
  const rango = (function(){
    const r = Math.random()*100; let acum=0;
    for(let i=0;i<rangosProb.length;i++){ acum+=rangosProb[i].prob; if(r<=acum) return rangosProb[i].rango; }
    return "ComÃºn"
